<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Kid - ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for gamified sounds -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Load Firebase (Required imports for Auth and Realtime Database) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- EXPOSE FIREBASE FUNCTIONS GLOBALLY ---
        // Auth Functions
        window.getAuth = getAuth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;

        // Realtime Database Functions
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;

        // --- USER-PROVIDED CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCaJX0lmumC-6J-iTHVB_PRe50Ww8oWp_g",
            authDomain: "smart-kid-balgram.firebaseapp.com",
            databaseURL: "https://smart-kid-balgram-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-kid-balgram",
            storageBucket: "smart-kid-balgram.firebasestorage.app",
            messagingSenderId: "340279199689",
            appId: "1:340279199689:web:8d45a29b1ea87f3869ca18",
            measurementId: "G-W402LPG44J"
        };

        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-smart-kid-app';

        if (firebaseConfig) {
            window.app = initializeApp(firebaseConfig);
            window.auth = getAuth(window.app);
            window.db = getDatabase(window.app);
            window.googleProvider = new GoogleAuthProvider();

            // 1. Initial Authentication Logic
            onAuthStateChanged(window.auth, async (user) => {
                const splash = document.getElementById('splash');
                const mainApp = document.getElementById('main-app-container');

                if (user) {
                    window.userId = user.uid;
                    await checkOrCreateUserProfile(user);
                } else {
                    try {
                        if (window.initialAuthToken) {
                            await signInWithCustomToken(window.auth, window.initialAuthToken);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Custom Token Error (Proceeding to Login Screen):", error);
                    }
                }

                if (splash) splash.classList.add('hidden');
                if (mainApp) mainApp.classList.remove('hidden');

                if (typeof window.initApp === 'function') {
                    window.initApp();
                }
            });

        } else {
            console.error("Firebase configuration not found.");
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary: #8b5cf6;
            /* Violet-500 */
            --secondary: #fcd34d;
            /* Amber-300 */
            --success: #10b981;
            /* Emerald-500 */
            --danger: #ef4444;
            /* Red-500 */
            --bg-dark: #1f2937;
            /* Gray-800 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Light gray background */
        }

        /* Custom Mobile View Styling (Android-like card effect) */
        .mobile-frame {
            max-width: 420px;
            height: 100vh;
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            background-color: #ffffff;
        }

        /* Gamification Styles */
        .stage-card {
            transition: all 0.3s ease;
        }

        .stage-card:hover {
            transform: scale(1.03) translateY(-5px);
            box-shadow: 0 8px 15px rgba(139, 92, 246, 0.4);
        }

        .correct-animation {
            animation: correctPulse 0.5s ease-in-out;
        }

        .wrong-animation {
            animation: wrongShake 0.5s ease-in-out;
        }

        @keyframes correctPulse {
            0% {
                transform: scale(1);
                background-color: white;
            }

            50% {
                transform: scale(1.05);
                background-color: var(--success);
            }

            100% {
                transform: scale(1);
                background-color: white;
            }
        }

        @keyframes wrongShake {

            0%,
            100% {
                transform: translateX(0);
                background-color: white;
            }

            20%,
            60% {
                transform: translateX(-5px);
                background-color: var(--danger);
            }

            40%,
            80% {
                transform: translateX(5px);
                background-color: var(--danger);
            }
        }

        /* Stage Path Styling (Candy Crush Path) - Applied to Subject Stages */
        #subject-stage-map {
            position: relative;
            padding: 20px 0;
            background: linear-gradient(to bottom, #d1d5db 0%, #f3f4f6 100%);
            border-radius: 1.5rem;
            max-width: 80%;
            /* Center the path structure */
            margin: 20px auto;
        }

        .subject-node {
            position: relative;
            margin: 40px auto;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            z-index: 10;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 4px solid #fff;
        }

        .subject-node:hover {
            transform: scale(1.1);
        }

        .subject-node::after {
            content: '';
            position: absolute;
            top: 90px;
            /* Position below node */
            left: 50%;
            width: 8px;
            height: 40px;
            /* Length of the connecting path */
            background: linear-gradient(to top, #6b7280, #9ca3af);
            /* Gradient path */
            z-index: 5;
            transform: translateX(-50%);
        }

        .subject-node:last-child::after {
            content: none;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="p-4 md:p-10 min-h-screen bg-gray-100 flex items-center justify-center">

    <div class="mobile-frame">

        <!-- Splash Screen / Loading -->
        <div id="splash"
            class="absolute inset-0 flex flex-col items-center justify-center bg-violet-700 z-50 transition-opacity duration-500">
            <div class="text-4xl font-extrabold text-white animate-pulse">Smart Kid</div>
            <p class="text-white mt-2 text-sm">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á... (Loading...)</p>
            <div class="loader mt-4"></div>
        </div>

        <!-- Main Application Container (Hidden until Auth is complete) -->
        <div id="main-app-container" class="h-full flex flex-col hidden">

            <!-- Dynamic Header (Changes per view) -->
            <header id="header-bar" class="p-4 bg-white shadow-md flex justify-between items-center z-10 sticky top-0">
                <h1 id="header-title" class="text-xl font-bold text-gray-800"></h1>
                <div class="flex items-center space-x-3">
                    <button id="notification-btn"
                        class="p-2 text-gray-500 hover:text-violet-500 rounded-full transition duration-150">
                        <!-- Icon: Bell -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </button>
                    <!-- Language toggle REMOVED from header -->
                </div>
            </header>

            <!-- Main Content Area -->
            <main id="content-area" class="flex-grow overflow-y-auto p-4 pb-20">

                <!-- Login/Initial Setup View -->
                <section id="login-view"
                    class="h-full flex flex-col items-center justify-center text-center space-y-8 hidden">
                    <h2 id="login-welcome" class="text-3xl font-extrabold text-violet-700"></h2>
                    <p id="login-tagline" class="text-gray-600 text-lg"></p>

                    <button id="google-sign-in-btn"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 flex items-center space-x-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white">
                            <path
                                d="M22.56 12.03c0-.75-.07-1.5-.2-2.25H12v4.25h6.05c-.27 1.42-1.09 2.61-2.25 3.44v3.13h4.03c2.36-2.17 3.78-5.38 3.78-9.57z"
                                opacity=".87" />
                            <path
                                d="M12 23c3.27 0 6.01-1.08 8.01-2.92l-4.03-3.13c-1.16.78-2.61 1.25-4 1.25-3.08 0-5.7-2.07-6.62-4.82H1.32v3.23C3.59 20.26 7.5 23 12 23z"
                                opacity=".87" />
                            <path
                                d="M5.38 14.15c-.2-.5-.31-1.04-.31-1.59s.11-1.09.31-1.59V8.04H1.32c-.59 1.14-.94 2.45-.94 3.86s.35 2.72.94 3.86l4.06-3.75z"
                                opacity=".87" />
                            <path
                                d="M12 3.63c1.61 0 3.06.55 4.21 1.63l3.52-3.35C18.01 1.15 15.27 0 12 0 7.5 0 3.59 2.74 1.32 6.35l4.06 3.23c.92-2.75 3.54-4.82 6.62-4.82z"
                                opacity=".87" />
                        </svg>
                        <span id="google-sign-in-text">Sign in with Google</span>
                    </button>
                </section>

                <!-- Profile Setup View -->
                <section id="profile-setup-view" class="p-6 bg-white rounded-xl shadow-2xl space-y-6 hidden">
                    <h2 id="setup-title" class="text-2xl font-extrabold text-violet-700 text-center">‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡•á‡§ü‡§Ö‡§™</h2>
                    <p id="setup-tagline" class="text-gray-600 text-center"></p>

                    <form id="profile-setup-form" class="space-y-4">
                        <div>
                            <label id="label-age" for="user-age" class="block text-sm font-medium text-gray-700">Age
                                (‡§µ‡§Ø)</label>
                            <input type="number" id="user-age" required min="8" max="18"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-violet-500 focus:ring-violet-500">
                        </div>
                        <div>
                            <label id="label-standard" for="user-standard"
                                class="block text-sm font-medium text-gray-700">Standard (‡§á‡§Ø‡§§‡•ç‡§§‡§æ)</label>
                            <select id="user-standard" required
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-violet-500 focus:ring-violet-500">
                                <option value="" disabled selected>Select Standard</option>
                                <option value="5">5th Standard</option>
                                <option value="6">6th Standard</option>
                                <option value="7">7th Standard</option>
                                <option value="8">8th Standard</option>
                                <option value="9">9th Standard</option>
                                <option value="10">10th Standard</option>
                            </select>
                        </div>
                        <div>
                            <label id="label-medium" for="user-medium"
                                class="block text-sm font-medium text-gray-700">Medium (‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ)</label>
                            <select id="user-medium" required
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-violet-500 focus:ring-violet-500">
                                <option value="" disabled selected>Select Medium</option>
                                <option value="CBSE">CBSE (‡§∏‡•Ä‡§¨‡•Ä‡§è‡§∏‡§à)</option>
                                <option value="State">State Board (‡§∞‡§æ‡§ú‡•ç‡§Ø ‡§Æ‡§Ç‡§°‡§≥)</option>
                            </select>
                        </div>
                        <button id="save-profile-btn" type="submit"
                            class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="save-profile-text">Save Profile</span>
                        </button>
                    </form>
                </section>

                <!-- Dashboard View (Now the Subject Stage Map) -->
                <section id="dashboard-view" class="space-y-6 hidden">
                    <!-- Profile Card -->
                    <div
                        class="p-6 bg-violet-600 text-white rounded-2xl shadow-xl flex items-center justify-between mb-4">
                        <div>
                            <p id="welcome-greeting" class="text-xl font-medium"></p>
                            <h2 id="dashboard-user-name" class="text-3xl font-extrabold truncate max-w-[200px]"></h2>
                            <p class="text-sm opacity-90 mt-1">Score: <span id="dashboard-user-score">0</span> üèÜ</p>
                        </div>
                        <img id="dashboard-profile-img" src="https://placehold.co/64x64/8b5cf6/ffffff?text=P"
                            class="w-16 h-16 rounded-full border-4 border-white object-cover shadow-md"
                            alt="Profile Picture">
                    </div>

                    <!-- Language Toggle (FIX: Moved here to the dashboard) -->
                    <div id="language-toggle" class="relative text-center mb-6">
                        <label class="text-gray-700 font-semibold text-sm mr-2">Change Language:</label>
                        <select id="lang-select"
                            class="bg-gray-100 text-gray-700 text-sm p-2 rounded-lg border border-gray-300 focus:ring-violet-500 focus:border-violet-500 transition duration-150">
                            <option value="en">English</option>
                            <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                            <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                        </select>
                    </div>

                    <!-- Weekly Test Card (Gamified/Premium) -->
                    <div id="weekly-test-card"
                        class="p-4 bg-yellow-400 rounded-2xl shadow-lg border-4 border-yellow-600 transform transition duration-300 hover:scale-[1.02] cursor-pointer hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">‚≠ê</span>
                                <div>
                                    <h3 id="test-card-title" class="text-xl font-bold text-yellow-800"></h3>
                                    <p id="test-card-status" class="text-sm text-yellow-700"></p>
                                </div>
                            </div>
                            <button id="test-card-btn"
                                class="bg-yellow-800 text-white text-sm font-bold py-1 px-4 rounded-full shadow-md"></button>
                        </div>
                    </div>

                    <!-- Subject Selection Grid (Now the Candy Crush Stage Map) -->
                    <h3 id="subjects-heading" class="text-2xl font-extrabold text-gray-800 text-center pt-4"></h3>
                    <div id="subject-stage-map" class="flex flex-col-reverse justify-end">
                        <!-- Subject Nodes (Stages) will be injected here -->
                    </div>
                </section>

                <!-- Stage Selection View (Now Difficulty Selection) -->
                <section id="stage-selection-view" class="space-y-6 hidden">
                    <h2 id="stage-selection-title" class="text-3xl font-extrabold text-violet-700 text-center"></h2>
                    <p id="stage-selection-subtitle" class="text-center text-gray-600"></p>
                    <div id="stage-list" class="flex flex-col space-y-4">
                        <!-- Difficulty Levels (Easy, Medium, Hard) will be injected here -->
                    </div>
                </section>

                <!-- Quiz View -->
                <section id="quiz-view" class="space-y-4 hidden">
                    <div class="flex justify-between items-center pb-2 border-b border-gray-200">
                        <div id="quiz-status" class="text-lg font-semibold text-violet-600"></div>
                        <div id="quiz-timer"
                            class="text-xl font-bold text-red-500 border border-red-500 rounded-full px-3 py-1">00:00
                        </div>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg">
                        <p id="quiz-question-text" class="text-xl font-medium text-gray-800"></p>
                    </div>

                    <div id="quiz-options-container" class="space-y-3">
                        <!-- Options will be injected here -->
                    </div>

                    <div class="flex justify-between pt-4">
                        <button id="quiz-next-btn"
                            class="bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition duration-300 hidden"
                            disabled>
                            <span id="next-btn-text">Next Question</span>
                        </button>
                    </div>
                </section>

                <!-- Quiz Result View -->
                <section id="quiz-result-view" class="text-center space-y-6 hidden">
                    <h2 id="result-title" class="text-4xl font-extrabold text-violet-700"></h2>
                    <p id="result-tagline" class="text-xl text-gray-600"></p>
                    <div id="result-score-ring"
                        class="mx-auto w-32 h-32 flex items-center justify-center rounded-full border-8 border-success bg-green-100 shadow-xl">
                        <span id="result-score" class="text-4xl font-bold text-success"></span>
                    </div>

                    <p id="result-details" class="text-lg font-medium text-gray-700"></p>

                    <div class="flex flex-col space-y-4">
                        <button id="review-answers-btn"
                            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="review-btn-text">Review Answers</span>
                        </button>
                        <button id="back-to-dashboard-btn"
                            class="w-full bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="dashboard-btn-text">Back to Dashboard</span>
                        </button>
                    </div>
                </section>

                <!-- Review Answers View -->
                <section id="review-view" class="space-y-6 hidden">
                    <h2 id="review-title" class="text-3xl font-extrabold text-violet-700 border-b pb-2"></h2>
                    <div id="review-list" class="space-y-6">
                        <!-- Reviewed questions will be injected here -->
                    </div>
                    <button id="close-review-btn"
                        class="w-full bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        <span id="close-review-text">Back to Results</span>
                    </button>
                </section>

                <!-- Profile View -->
                <section id="profile-view" class="space-y-6 hidden">
                    <h2 id="profile-page-title" class="text-3xl font-extrabold text-violet-700 text-center"></h2>
                    <div class="p-6 bg-white rounded-xl shadow-2xl space-y-4">
                        <img id="profile-page-img" src="https://placehold.co/100x100/8b5cf6/ffffff?text=P"
                            class="w-24 h-24 rounded-full border-4 border-violet-500 object-cover mx-auto shadow-lg"
                            alt="Profile Picture">
                        <p id="profile-user-name" class="text-2xl font-bold text-center"></p>
                        <p id="profile-user-id" class="text-xs text-gray-500 text-center truncate"></p>
                        <div id="profile-details" class="space-y-2">
                            <p id="profile-standard" class="text-gray-700"><span class="font-semibold">Standard:</span>
                                10th</p>
                            <p id="profile-medium" class="text-gray-700"><span class="font-semibold">Medium:</span> CBSE
                            </p>
                        </div>
                        <p id="test-paid-status" class="text-sm text-center font-medium"></p>
                    </div>
                    <button id="sign-out-btn"
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        <span id="sign-out-text">Sign Out</span>
                    </button>
                </section>

                <!-- Leaderboard View -->
                <section id="leaderboard-view" class="space-y-4 hidden">
                    <h2 id="leaderboard-title" class="text-3xl font-extrabold text-violet-700 border-b pb-2"></h2>
                    <div id="leaderboard-list" class="space-y-3">
                        <!-- Leaderboard list will be injected here -->
                        <p id="leaderboard-loading" class="text-center text-gray-500"></p>
                    </div>
                </section>

                <!-- History View -->
                <section id="history-view" class="space-y-4 hidden">
                    <h2 id="history-title" class="text-3xl font-extrabold text-violet-700 border-b pb-2"></h2>
                    <div id="history-list" class="space-y-3">
                        <!-- History list will be injected here -->
                        <p id="history-loading" class="text-center text-gray-500"></p>
                    </div>
                </section>

                <!-- Global Modal for custom alerts/confirmation (No alert() allowed) -->
                <div id="global-modal"
                    class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50">
                    <div
                        class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 ease-out duration-300">
                        <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                        <p id="modal-message" class="text-gray-600 mb-6"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-full hover:bg-gray-100 transition duration-150">Cancel</button>
                            <button id="modal-confirm-btn"
                                class="px-4 py-2 bg-violet-500 text-white rounded-full hover:bg-violet-600 transition duration-150">Confirm</button>
                        </div>
                    </div>
                </div>

            </main>

            <!-- Bottom Navigation Bar (Fixed for Mobile Feel) -->
            <nav id="bottom-nav"
                class="fixed bottom-0 left-0 right-0 max-w-[420px] mx-auto bg-white border-t border-gray-200 shadow-2xl flex justify-around items-center h-16 z-20">
                <!-- Dashboard -->
                <button data-view="dashboard"
                    class="nav-item flex flex-col items-center p-2 text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span id="nav-dashboard-text" class="text-xs">Dashboard</span>
                </button>
                <!-- Leaderboard -->
                <button data-view="leaderboard"
                    class="nav-item flex flex-col items-center p-2 text-gray-500 hover:text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 10h4.765a2 2 0 01.358.31l1.598 1.597a2 2 0 010 2.828l-1.598 1.598a2 2 0 01-.358.31H14m-12 0h4.765a2 2 0 00.358.31l1.598 1.597a2 2 0 000 2.828l-1.598 1.598a2 2 0 00-.358.31H12M3 21h18" />
                    </svg>
                    <span id="nav-leaderboard-text" class="text-xs">Leaderboard</span>
                </button>
                <!-- History -->
                <button data-view="history"
                    class="nav-item flex flex-col items-center p-2 text-gray-500 hover:text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="nav-history-text" class="text-xs">History</span>
                </button>
                <!-- Profile -->
                <button data-view="profile"
                    class="nav-item flex flex-col items-center p-2 text-gray-500 hover:text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="nav-profile-text" class="text-xs">Profile</span>
                </button>
            </nav>

        </div>
    </div>

    <script>
        // --- GLOBAL STATE AND CONFIGURATION ---
        const API_URL_TRIVIA = 'https://opentdb.com/api.php';

        let currentView = 'dashboard';
        let currentUser = null;
        let userProfile = null;
        let quizSession = null;
        let currentLanguage = 'mr';
        let isWeeklyTestAvailable = false;
        let isTestPaid = false;

        // Subject/Stage Definitions with colors and emojis
        const SUBJECTS_DATA = [
            { name: 'Math', emoji: 'üìê', color: 'bg-red-500', categoryId: 19 },
            { name: 'Science', emoji: 'üß™', color: 'bg-green-500', categoryId: 17 },
            { name: 'History', emoji: 'üèõÔ∏è', color: 'bg-blue-500', categoryId: 23 },
            { name: 'Geography', emoji: 'üåç', color: 'bg-amber-500', categoryId: 22 },
            { name: 'Marathi Grammar', emoji: 'üìö', color: 'bg-purple-500', categoryId: 9 } // General Knowledge fallback
        ];
        const SUBJECTS = SUBJECTS_DATA.map(s => s.name);
        const TRIVIA_CATEGORIES = SUBJECTS_DATA.reduce((acc, s) => {
            acc[s.name] = s.categoryId;
            return acc;
        }, {});

        const DIFFICULTIES = {
            'easy': { label: { en: 'Easy', mr: '‡§∏‡•ã‡§™‡•á', hi: '‡§Ü‡§∏‡§æ‡§®' }, emoji: 'üë∂', color: 'bg-emerald-500' },
            'medium': { label: { en: 'Medium', mr: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', hi: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ' }, emoji: 'üßë', color: 'bg-yellow-500' },
            'hard': { label: { en: 'Hard', mr: '‡§ï‡§†‡•Ä‡§£', hi: '‡§ï‡§†‡§ø‡§®' }, emoji: 'üß†', color: 'bg-red-500' }
        };

        // Localization Texts
        const TEXTS = {
            'login-welcome': { en: 'Welcome to Smart Kid!', mr: '‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§ï‡§ø‡§°‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§™‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á!', hi: '‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§ï‡§ø‡§° ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à!' },
            'login-tagline': { en: 'Learn like you play a game!', mr: '‡§ñ‡•á‡§≥‡§æ‡§∏‡§æ‡§∞‡§ñ‡•á ‡§∂‡§ø‡§ï‡§æ!', hi: '‡§ñ‡•á‡§≤ ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§∏‡•Ä‡§ñ‡•á‡§Ç!' },
            'google-sign-in-text': { en: 'Sign in with Google', mr: '‡§ó‡•Å‡§ó‡§≤‡§®‡•á ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡§æ', hi: 'Google ‡§∏‡•á ‡§∏‡§æ‡§á‡§® ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç' },
            'setup-title': { en: 'Profile Setup', mr: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§∏‡•á‡§ü‡§Ö‡§™', hi: '‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç' },
            'setup-tagline': { en: 'Tell us about yourself to tailor your content.', mr: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§ú‡•Å‡§≥‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Ü‡§™‡§≤‡•ç‡§Ø‡§æ‡§¨‡§¶‡•ç‡§¶‡§≤ ‡§∏‡§æ‡§Ç‡§ó‡§æ.', hi: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§™‡§®‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§¨‡§§‡§æ‡§è‡§Ç‡•§' },
            'label-age': { en: 'Age (‡§µ‡§Ø)', mr: '‡§µ‡§Ø (Age)', hi: '‡§Ü‡§Ø‡•Å (Age)' },
            'label-standard': { en: 'Standard (‡§á‡§Ø‡§§‡•ç‡§§‡§æ)', mr: '‡§á‡§Ø‡§§‡•ç‡§§‡§æ (Standard)', hi: '‡§ï‡§ï‡•ç‡§∑‡§æ (Standard)' },
            'label-medium': { en: 'Medium (‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ)', mr: '‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ (Medium)', hi: '‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ (Medium)' },
            'save-profile-text': { en: 'Save Profile & Start', mr: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§ú‡§§‡§® ‡§ï‡§∞‡§æ ‡§Ü‡§£‡§ø ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ', hi: '‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡§π‡•á‡§ú‡•á‡§Ç ‡§î‡§∞ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç' },
            'nav-dashboard-text': { en: 'Dashboard', mr: '‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°', hi: '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°' },
            'nav-leaderboard-text': { en: 'Leaderboard', mr: '‡§≤‡•Ä‡§°‡§∞‡§¨‡•ã‡§∞‡•ç‡§°', hi: '‡§≤‡•Ä‡§°‡§∞‡§¨‡•ã‡§∞‡•ç‡§°' },
            'nav-history-text': { en: 'History', mr: '‡§á‡§§‡§ø‡§π‡§æ‡§∏', hi: '‡§á‡§§‡§ø‡§π‡§æ‡§∏' },
            'nav-profile-text': { en: 'Profile', mr: '‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤', hi: '‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤' },
            'welcome-greeting': { en: 'Hello, Scholar!', mr: '‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§µ‡§ø‡§¶‡•ç‡§µ‡§æ‡§®‡§æ!', hi: '‡§®‡§Æ‡§∏‡•ç‡§§‡•á, ‡§µ‡§ø‡§¶‡•ç‡§µ‡§æ‡§®!' },
            'subjects-heading': { en: 'Choose Your Subject Stage:', mr: '‡§§‡•Å‡§Æ‡§ö‡§æ ‡§µ‡§ø‡§∑‡§Ø ‡§ü‡§™‡•ç‡§™‡§æ ‡§®‡§ø‡§µ‡§°‡§æ:', hi: '‡§Ö‡§™‡§®‡§æ ‡§µ‡§ø‡§∑‡§Ø ‡§∏‡•ç‡§ü‡•á‡§ú ‡§ö‡•Å‡§®‡•á‡§Ç:' },
            'stage-selection-title': { en: 'Select Difficulty', mr: '‡§ï‡§†‡•Ä‡§£ ‡§™‡§æ‡§§‡§≥‡•Ä ‡§®‡§ø‡§µ‡§°‡§æ', hi: '‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§∏‡•ç‡§§‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç' },
            'stage-selection-subtitle': { en: 'Higher difficulty means higher score points!', mr: '‡§ú‡§æ‡§∏‡•ç‡§§ ‡§ï‡§†‡§ø‡§£ ‡§Æ‡•ç‡§π‡§£‡§ú‡•á ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§ó‡•Å‡§£!', hi: '‡§Ö‡§ß‡§ø‡§ï ‡§ï‡§†‡§ø‡§®‡§æ‡§à ‡§ï‡§æ ‡§Ö‡§∞‡•ç‡§• ‡§π‡•à ‡§Ö‡§ß‡§ø‡§ï ‡§Ö‡§Ç‡§ï!' },
            'next-btn-text': { en: 'Next Question', mr: '‡§™‡•Å‡§¢‡§ö‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®', hi: '‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®' },
            'result-title-success': { en: 'Fantastic Job!', mr: '‡§Ö‡§™‡•ç‡§∞‡§§‡§ø‡§Æ ‡§ï‡§æ‡§Æ!', hi: '‡§∂‡§æ‡§®‡§¶‡§æ‡§∞ ‡§ï‡§æ‡§Æ!' },
            'result-title-fail': { en: 'Good Effort!', mr: '‡§ö‡§æ‡§Ç‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§®!', hi: '‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏!' },
            'result-tagline': { en: 'You earned {score} points!', mr: '‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä {score} ‡§ó‡•Å‡§£ ‡§Æ‡§ø‡§≥‡§µ‡§≤‡•á!', hi: '‡§Ü‡§™‡§®‡•á {score} ‡§Ö‡§Ç‡§ï ‡§Ö‡§∞‡•ç‡§ú‡§ø‡§§ ‡§ï‡§ø‡§è!' },
            'result-details': { en: 'Solved: {solved}/{total} | Correct: {correct}', mr: '‡§∏‡•ã‡§°‡§µ‡§≤‡•á: {solved}/{total} | ‡§¨‡§∞‡•ã‡§¨‡§∞: {correct}', hi: '‡§π‡§≤ ‡§ï‡§ø‡§è ‡§ó‡§è: {solved}/{total} | ‡§∏‡§π‡•Ä: {correct}' },
            'review-btn-text': { en: 'Review Answers', mr: '‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§Ç‡§ö‡•á ‡§™‡•Å‡§®‡§∞‡§æ‡§µ‡§≤‡•ã‡§ï‡§® ‡§ï‡§∞‡§æ', hi: '‡§â‡§§‡•ç‡§§‡§∞‡•ã‡§Ç ‡§ï‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç' },
            'dashboard-btn-text': { en: 'Back to Dashboard', mr: '‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°‡§µ‡§∞ ‡§™‡§∞‡§§', hi: '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏' },
            'close-review-text': { en: 'Back to Results', mr: '‡§®‡§ø‡§ï‡§æ‡§≤‡§æ‡§Ç‡§µ‡§∞ ‡§™‡§∞‡§§', hi: '‡§™‡§∞‡§ø‡§£‡§æ‡§Æ‡•ã‡§Ç ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏' },
            'back-to-history-text': { en: 'Back to History', mr: '‡§á‡§§‡§ø‡§π‡§æ‡§∏‡§æ‡§µ‡§∞ ‡§™‡§∞‡§§', hi: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏' }, // New key
            'profile-page-title': { en: 'Your Profile', mr: '‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤', hi: '‡§Ü‡§™‡§ï‡•Ä ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤' },
            'sign-out-text': { en: 'Sign Out', mr: '‡§∏‡§æ‡§á‡§® ‡§Ü‡§â‡§ü ‡§ï‡§∞‡§æ', hi: '‡§∏‡§æ‡§á‡§® ‡§Ü‡§â‡§ü ‡§ï‡§∞‡•á‡§Ç' },
            'test-card-title': { en: 'Weekly Scholar Test', mr: '‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§∏‡•ç‡§ï‡•â‡§≤‡§∞ ‡§ö‡§æ‡§ö‡§£‡•Ä', hi: '‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§∏‡•ç‡§ï‡•â‡§≤‡§∞ ‡§ü‡•á‡§∏‡•ç‡§ü' },
            'test-card-status-inactive': { en: 'Check back next Sunday!', mr: '‡§™‡•Å‡§¢‡§ö‡•ç‡§Ø‡§æ ‡§∞‡§µ‡§ø‡§µ‡§æ‡§∞‡•Ä ‡§§‡§™‡§æ‡§∏‡§æ!', hi: '‡§Ö‡§ó‡§≤‡•á ‡§∞‡§µ‡§ø‡§µ‡§æ‡§∞ ‡§ï‡•ã ‡§¶‡•á‡§ñ‡•á‡§Ç!' },
            'test-card-status-active': { en: 'Test is Live! Click to Start.', mr: '‡§ö‡§æ‡§ö‡§£‡•Ä ‡§≤‡§æ‡§à‡§µ‡•ç‡§π ‡§Ü‡§π‡•á! ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ.', hi: '‡§ü‡•á‡§∏‡•ç‡§ü ‡§≤‡§æ‡§á‡§µ ‡§π‡•à! ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§' },
            'test-card-status-paid': { en: 'Test Paid! ‚úÖ', mr: '‡§ö‡§æ‡§ö‡§£‡•Ä ‡§∏‡§∂‡•Å‡§≤‡•ç‡§ï! ‚úÖ', hi: '‡§ü‡•á‡§∏‡•ç‡§ü ‡§™‡•á‡§°! ‚úÖ' },
            'test-card-status-pay': { en: 'One-time fee: ‚Çπ9.00', mr: '‡§è‡§ï-‡§µ‡•á‡§≥ ‡§∂‡•Å‡§≤‡•ç‡§ï: ‚Çπ‡•Ø.‡•¶‡•¶', hi: '‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï: ‚Çπ‡•Ø.‡•¶‡•¶' },
            'test-card-btn-start': { en: 'START', mr: '‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ', hi: '‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç' },
            'test-card-btn-pay': { en: 'PAY ‚Çπ9.00', mr: '‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡§æ ‚Çπ‡•Ø.‡•¶‡•¶', hi: '‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç ‚Çπ‡•Ø.‡•¶‡•¶' },
            'leaderboard-title': { en: 'Top Global Scorers ü•á', mr: '‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§ú‡§æ‡§ó‡§§‡§ø‡§ï ‡§∏‡•ç‡§ï‡•ã‡§Ö‡§∞‡§∞‡•ç‡§∏ ü•á', hi: '‡§∂‡•Ä‡§∞‡•ç‡§∑ ‡§µ‡•à‡§∂‡•ç‡§µ‡§ø‡§ï ‡§∏‡•ç‡§ï‡•ã‡§∞‡§∞ ü•á' },
            'history-title': { en: 'My Quiz History üìú', mr: '‡§Æ‡§æ‡§ù‡§æ ‡§ï‡•ç‡§µ‡§ø‡§ù ‡§á‡§§‡§ø‡§π‡§æ‡§∏ üìú', hi: '‡§Æ‡•á‡§∞‡§æ ‡§ï‡•ç‡§µ‡§ø‡§ú‡§º ‡§á‡§§‡§ø‡§π‡§æ‡§∏ üìú' },
            'history-loading': { en: 'Loading history...', mr: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...', hi: '‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...' },
            'leaderboard-loading': { en: 'Loading leaderboard...', mr: '‡§≤‡•Ä‡§°‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...', hi: '‡§≤‡•Ä‡§°‡§∞‡§¨‡•ã‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...' },
            'question-loading': { en: 'Fetching Questions...', mr: '‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ü‡§£‡§≤‡•á ‡§ú‡§æ‡§§ ‡§Ü‡§π‡•á‡§§...', hi: '‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§è ‡§ú‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...' },
            'question-generating-error': { en: 'Could not fetch questions. Try again.', mr: '‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Æ‡§ø‡§≥‡•Ç ‡§∂‡§ï‡§≤‡•á ‡§®‡§æ‡§π‡•Ä. ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.', hi: '‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡•á‡•§ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç.' },
            'modal-pay-title': { en: 'One-time Payment for Test', mr: '‡§ö‡§æ‡§ö‡§£‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§è‡§ï‡§¶‡§æ‡§ö ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü', hi: '‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®' },
            'modal-pay-message': { en: 'Confirm payment of ‚Çπ9.00 (One-time fee) to unlock all weekly tests permanently.', mr: '‡§∏‡§∞‡•ç‡§µ ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§ö‡§æ‡§ö‡§£‡•ç‡§Ø‡§æ ‡§ï‡§æ‡§Ø‡§Æ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™‡•Ä ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‚Çπ‡•Ø.‡•¶‡•¶ (‡§è‡§ï-‡§µ‡•á‡§≥ ‡§∂‡•Å‡§≤‡•ç‡§ï) ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü‡§ö‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡•Ä ‡§ï‡§∞‡§æ.', hi: '‡§∏‡§≠‡•Ä ‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ö‡§®‡§≤‡•â‡§ï ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‚Çπ‡•Ø.‡•¶‡•¶ (‡§è‡§ï ‡§¨‡§æ‡§∞ ‡§ï‡§æ ‡§∂‡•Å‡§≤‡•ç‡§ï) ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç‡•§' },
            'review-explanation-text': { en: 'Correct Answer Explanation', mr: '‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§ö‡•á ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£', hi: '‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ ‡§ï‡§æ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü‡•Ä‡§ï‡§∞‡§£' },
            'profile-test-paid': { en: 'Weekly Test Status: PAID (Unlocked Permanently) üéâ', mr: '‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§ö‡§æ‡§ö‡§£‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä: ‡§∏‡§∂‡•Å‡§≤‡•ç‡§ï (‡§ï‡§æ‡§Ø‡§Æ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™‡•Ä ‡§Ö‡§®‡§≤‡•â‡§ï) üéâ', hi: '‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡•ç‡§•‡§ø‡§§‡§ø: ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ (‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§Ö‡§®‡§≤‡•â‡§ï) üéâ' },
            'profile-test-unpaid': { en: 'Weekly Test Status: UNPAID üîí', mr: '‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§ö‡§æ‡§ö‡§£‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡•Ä: ‡§∏‡§∂‡•Å‡§≤‡•ç‡§ï ‡§®‡§æ‡§π‡•Ä üîí', hi: '‡§∏‡§æ‡§™‡•ç‡§§‡§æ‡§π‡§ø‡§ï ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡•ç‡§•‡§ø‡§§‡§ø: ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ üîí' }
        };

        // --- UTILITY FUNCTIONS ---

        // Decode HTML entities (important for Open Trivia API)
        const decodeHtml = (html) => {
            const txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        }

        // Get localized text
        const L = (key) => TEXTS[key]?.[currentLanguage] || TEXTS[key]?.['en'] || key;

        // Set text content for all elements with a specific ID
        const localizeElements = () => {
            document.getElementById('header-title').textContent = 'Smart Kid';
            document.getElementById('login-welcome').textContent = L('login-welcome');
            document.getElementById('login-tagline').textContent = L('login-tagline');
            document.getElementById('google-sign-in-text').textContent = L('google-sign-in-text');

            document.getElementById('setup-title').textContent = L('setup-title');
            document.getElementById('setup-tagline').textContent = L('setup-tagline');
            document.getElementById('label-age').textContent = L('label-age');
            document.getElementById('label-standard').textContent = L('label-standard');
            document.getElementById('label-medium').textContent = L('label-medium');
            document.getElementById('save-profile-text').textContent = L('save-profile-text');

            document.getElementById('nav-dashboard-text').textContent = L('nav-dashboard-text');
            document.getElementById('nav-leaderboard-text').textContent = L('nav-leaderboard-text');
            document.getElementById('nav-history-text').textContent = L('nav-history-text');
            document.getElementById('nav-profile-text').textContent = L('nav-profile-text');

            if (userProfile) {
                document.getElementById('welcome-greeting').textContent = L('welcome-greeting');
                document.getElementById('subjects-heading').textContent = L('subjects-heading');
            }

            document.getElementById('next-btn-text').textContent = L('next-btn-text');
            document.getElementById('review-btn-text').textContent = L('review-btn-text');
            document.getElementById('dashboard-btn-text').textContent = L('dashboard-btn-text');

            document.getElementById('profile-page-title').textContent = L('profile-page-title');
            document.getElementById('sign-out-text').textContent = L('sign-out-text');
            document.getElementById('leaderboard-title').textContent = L('leaderboard-title');
            document.getElementById('history-title').textContent = L('history-title');
            document.getElementById('leaderboard-loading').textContent = L('leaderboard-loading');
            document.getElementById('history-loading').textContent = L('history-loading');

            if (userProfile) {
                // Re-render views to apply new language and state
                updateProfileUI();
                if (currentView === 'result') renderResultView();
                if (currentView === 'review') renderReviewView();
                if (currentView === 'dashboard') renderDashboard();
            }
        };

        // Tone.js Sound System (Gamified Interaction)
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "square" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
        }).toDestination();

        const playSound = (type) => {
            try {
                switch (type) {
                    case 'correct':
                        synth.triggerAttackRelease(['C5', 'E5', 'G5'], '8n');
                        break;
                    case 'wrong':
                        synth.triggerAttackRelease('C4', '4n');
                        break;
                    case 'next':
                        synth.triggerAttackRelease('D4', '16n');
                        break;
                    case 'level_up':
                        synth.triggerAttackRelease(['C5', 'G5', 'C6'], '2n', '+0.1');
                        break;
                }
            } catch (e) {
                console.warn("Audio context not started or Tone.js error:", e);
            }
        };

        // Exponential Backoff for API calls
        const backoffFetch = async (url, options, maxRetries = 3) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        throw new Error("Rate limit exceeded");
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        // --- FIREBASE AND AUTHENTICATION LOGIC ---

        const signInWithGoogle = async () => {
            try {
                await Tone.start();
                const result = await window.signInWithPopup(window.auth, window.googleProvider);
                const user = result.user;
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showModal(L('modal-error-title') || 'Error', error.message, false);
                }
            }
        };

        const signOutUser = async () => {
            try {
                await window.signOut(window.auth);
                location.reload();
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        };

        const checkOrCreateUserProfile = async (user) => {
            const userRef = ref(window.db, `artifacts/${window.appId}/users/${user.uid}/profile`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                userProfile = snapshot.val();
                // Ensure isTestPaid status exists
                if (typeof userProfile.isTestPaid === 'undefined') {
                    userProfile.isTestPaid = false;
                    await update(userRef, { isTestPaid: false });
                }
                if (!userProfile.standard || !userProfile.medium) {
                    renderView('profile-setup');
                } else {
                    currentUser = user;
                    isTestPaid = userProfile.isTestPaid;
                    renderView('dashboard');
                }
            } else {
                currentUser = user;
                renderView('profile-setup');
            }
            updateProfileUI();
            checkWeeklyTestStatus();
        };

        const saveProfile = async (event) => {
            event.preventDefault();
            const age = document.getElementById('user-age').value;
            const standard = document.getElementById('user-standard').value;
            const medium = document.getElementById('user-medium').value;

            if (!age || !standard || !medium) return;

            const newProfile = {
                name: currentUser.displayName || 'Smart Kid User',
                email: currentUser.email || 'N/A',
                photoURL: currentUser.photoURL || 'https://placehold.co/64x64/8b5cf6/ffffff?text=P',
                age: parseInt(age),
                standard: standard,
                medium: medium,
                score: 0,
                isTestPaid: false, // Default unpaid
                lastUpdated: Date.now()
            };

            const profileRef = ref(window.db, `artifacts/${window.appId}/users/${currentUser.uid}/profile`);
            await set(profileRef, newProfile);
            userProfile = newProfile;
            isTestPaid = false;
            updateProfileUI();
            renderView('dashboard');
        };

        const updateProfileUI = () => {
            if (userProfile) {
                document.getElementById('dashboard-user-name').textContent = userProfile.name;
                document.getElementById('dashboard-profile-img').src = userProfile.photoURL;
                document.getElementById('dashboard-user-score').textContent = userProfile.score || 0;

                document.getElementById('profile-page-img').src = userProfile.photoURL;
                document.getElementById('profile-user-name').textContent = userProfile.name;
                document.getElementById('profile-user-id').textContent = `User ID: ${window.userId}`;
                document.getElementById('profile-standard').innerHTML = `<span class="font-semibold">${L('label-standard')}:</span> ${userProfile.standard}th`;
                document.getElementById('profile-medium').innerHTML = `<span class="font-semibold">${L('label-medium')}:</span> ${userProfile.medium}`;

                // Update Test Paid Status on Profile View
                const paidStatusText = userProfile.isTestPaid ? L('profile-test-paid') : L('profile-test-unpaid');
                document.getElementById('test-paid-status').textContent = paidStatusText;
                document.getElementById('test-paid-status').className = `text-sm text-center font-medium ${userProfile.isTestPaid ? 'text-emerald-600' : 'text-red-600'}`;
            }
        };

        const saveQuizHistory = async (session) => {
            const historyRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/history/${Date.now()}`);
            await set(historyRef, session);

            const newScore = (userProfile.score || 0) + session.score;
            const userScoreRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/profile`);
            await update(userScoreRef, { score: newScore });
            userProfile.score = newScore;
            updateProfileUI();
        };

        // --- OPEN TRIVIA API FOR QUESTIONS ---

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        const fetchQuizQuestions = async (subject, difficulty, count = 10) => {
            const categoryId = TRIVIA_CATEGORIES[subject] || 9;
            const diffParam = difficulty === 'hard' ? 'hard' : difficulty === 'medium' ? 'medium' : 'easy';

            const url = `${API_URL_TRIVIA}?amount=${count}&category=${categoryId}&difficulty=${diffParam}&type=multiple`;

            const questionContainer = document.getElementById('quiz-question-text');
            const optionsContainer = document.getElementById('quiz-options-container');

            questionContainer.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="loader border-violet-500"></div><p class="text-gray-500">${L('question-loading')}</p></div>`;
            optionsContainer.innerHTML = '';

            try {
                const responseData = await backoffFetch(url);

                if (responseData.response_code !== 0) {
                    throw new Error(`Trivia API Error Code: ${responseData.response_code}`);
                }

                const questions = responseData.results.map(q => {
                    const incorrect = q.incorrect_answers.map(decodeHtml);
                    const correct = decodeHtml(q.correct_answer);

                    const allOptions = [...incorrect, correct];
                    shuffleArray(allOptions);

                    const correctIndex = allOptions.findIndex(opt => opt === correct);

                    // Open Trivia questions are English only, content is duplicated for multilingual placeholders
                    return {
                        question_en: decodeHtml(q.question),
                        question_mr: decodeHtml(q.question),
                        question_hi: decodeHtml(q.question),
                        options_en: allOptions,
                        options_mr: allOptions,
                        options_hi: allOptions,
                        correct_answer_index: correctIndex,
                        // Simple explanation based on the correct answer
                        explanation_en: `The correct answer is "${correct}" (Topic: ${q.category}).`,
                        explanation_mr: `‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§â‡§§‡•ç‡§§‡§∞ ‡§Ü‡§π‡•á: "${correct}" (‡§µ‡§ø‡§∑‡§Ø: ${q.category})`,
                        explanation_hi: `‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞ ‡§π‡•à: "${correct}" (‡§µ‡§ø‡§∑‡§Ø: ${q.category})`,
                        attempted: false,
                        userAnswer: -1
                    };
                });

                return questions;

            } catch (error) {
                console.error("Trivia API Fetch Error:", error);
                questionContainer.textContent = L('question-generating-error');
                showModal('API Error', L('question-generating-error'), false);
                return null;
            }
        };


        // --- GAME LOGIC ---

        const startQuiz = async (subject, difficulty, isTest = false) => {
            const questionData = await fetchQuizQuestions(subject, difficulty, 10);

            if (!questionData || questionData.length === 0) {
                renderView('dashboard');
                return;
            }

            quizSession = {
                subject: subject,
                difficulty: difficulty,
                questions: questionData,
                currentQIndex: 0,
                score: 0,
                correctCount: 0,
                isTest: isTest,
                startTime: Date.now(),
                duration: 0,
            };

            renderView('quiz');
            renderQuestion();
            startQuizTimer();
            playSound('next');
        };

        let quizTimerInterval = null;
        const startQuizTimer = () => {
            const timerElement = document.getElementById('quiz-timer');
            let totalSeconds = 0;

            clearInterval(quizTimerInterval);
            quizTimerInterval = setInterval(() => {
                totalSeconds++;
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                timerElement.textContent = `${minutes}:${seconds}`;
            }, 1000);
        };

        const stopQuizTimer = () => {
            clearInterval(quizTimerInterval);
            const timerText = document.getElementById('quiz-timer').textContent;
            const parts = timerText.split(':').map(Number);
            quizSession.duration = parts[0] * 60 + parts[1];
        };

        const renderQuestion = () => {
            if (!quizSession) return;
            const q = quizSession.questions[quizSession.currentQIndex];
            const currentQ = quizSession.currentQIndex + 1;
            const totalQ = quizSession.questions.length;

            document.getElementById('quiz-status').textContent = `Q ${currentQ}/${totalQ} - ${quizSession.subject}`;
            document.getElementById('quiz-timer').classList.remove('hidden');

            const questionKey = `question_${currentLanguage}`;
            const optionsKey = `options_${currentLanguage}`;
            const options = q[optionsKey] || q.options_en;
            const questionText = q[questionKey] || q.question_en;

            document.getElementById('quiz-question-text').textContent = questionText;
            document.getElementById('quiz-next-btn').classList.add('hidden');
            document.getElementById('quiz-next-btn').disabled = true;

            const optionsContainer = document.getElementById('quiz-options-container');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('pointer-events-none');

            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 bg-white rounded-xl shadow-lg border-2 border-gray-200 transition duration-150 hover:border-violet-500 hover:shadow-xl focus:outline-none option-btn`;
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.dataset.index = index;
                button.onclick = () => selectOption(index);
                optionsContainer.appendChild(button);
            });
        };

        const selectOption = (selectedIndex) => {
            if (!quizSession) return;

            const q = quizSession.questions[quizSession.currentQIndex];
            const isCorrect = selectedIndex === q.correct_answer_index;

            q.attempted = true;
            q.userAnswer = selectedIndex;

            document.getElementById('quiz-options-container').classList.add('pointer-events-none');

            const optionButtons = document.querySelectorAll('#quiz-options-container .option-btn');
            optionButtons.forEach(btn => {
                const index = parseInt(btn.dataset.index);

                btn.classList.remove('hover:border-violet-500', 'hover:shadow-xl');

                if (index === q.correct_answer_index) {
                    btn.classList.add('bg-emerald-100', 'border-emerald-500', 'correct-animation');
                } else if (index === selectedIndex) {
                    btn.classList.add('bg-red-100', 'border-red-500', 'wrong-animation');
                } else {
                    btn.classList.add('opacity-50');
                }
            });

            if (isCorrect) {
                quizSession.correctCount++;
                let difficultyBonus = 0;
                if (quizSession.difficulty === 'medium') difficultyBonus = 1;
                if (quizSession.difficulty === 'hard') difficultyBonus = 2;
                quizSession.score += 10 * (1 + difficultyBonus);
                playSound('correct');
            } else {
                playSound('wrong');
            }

            document.getElementById('quiz-next-btn').classList.remove('hidden');
            document.getElementById('quiz-next-btn').disabled = false;
        };

        const nextQuestion = () => {
            if (!quizSession) return;

            if (quizSession.currentQIndex < quizSession.questions.length - 1) {
                quizSession.currentQIndex++;
                renderQuestion();
                playSound('next');
            } else {
                stopQuizTimer();
                endQuiz();
            }
        };

        const endQuiz = () => {
            playSound('level_up');
            saveQuizHistory(quizSession);
            renderView('result');
        };

        const renderResultView = () => {
            if (!quizSession) return;

            const titleElement = document.getElementById('result-title');
            const scoreRing = document.getElementById('result-score-ring');
            const scoreElement = document.getElementById('result-score');
            const taglineElement = document.getElementById('result-tagline');
            const detailsElement = document.getElementById('result-details');

            const score = quizSession.score;
            const totalQ = quizSession.questions.length;
            const correctQ = quizSession.correctCount;

            scoreRing.classList.remove('border-success', 'border-red-500', 'bg-green-100', 'bg-red-100', 'text-success', 'text-red-500');

            if (correctQ / totalQ > 0.7) {
                titleElement.textContent = L('result-title-success');
                scoreRing.classList.add('border-success', 'bg-green-100');
                scoreElement.classList.add('text-success');
            } else {
                titleElement.textContent = L('result-title-fail');
                scoreRing.classList.add('border-red-500', 'bg-red-100');
                scoreElement.classList.add('text-red-500');
            }

            scoreElement.textContent = score;
            taglineElement.textContent = L('result-tagline').replace('{score}', score);
            detailsElement.textContent = L('result-details')
                .replace('{solved}', totalQ)
                .replace('{total}', totalQ)
                .replace('{correct}', correctQ);
        };

        // FIX: Combined review logic into one function with source tracking
        const openReviewScreen = (session, sourceView) => {
            quizSession = session;
            renderView('review');

            // Set close button logic based on where the call came from
            if (sourceView === 'history') {
                document.getElementById('close-review-btn').onclick = () => renderView('history');
                document.getElementById('close-review-text').textContent = L('back-to-history-text');
            } else { // Source: result
                document.getElementById('close-review-btn').onclick = () => renderView('result');
                document.getElementById('close-review-text').textContent = L('close-review-text');
            }
        };

        const renderReviewView = () => {
            if (!quizSession) return;

            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';
            document.getElementById('review-title').textContent = `${L('review-btn-text')} - ${quizSession.subject}`;

            quizSession.questions.forEach((q, index) => {
                const isCorrect = q.userAnswer === q.correct_answer_index;

                const questionKey = `question_${currentLanguage}`;
                const explanationKey = `explanation_${currentLanguage}`;
                const optionsKey = `options_${currentLanguage}`;

                const qText = q[questionKey] || q.question_en;
                const explanationText = q[explanationKey] || q.explanation_en;
                const options = q[optionsKey] || q.options_en;

                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-lg border-l-4 ${isCorrect ? 'border-emerald-500 bg-emerald-50' : 'border-red-500 bg-red-50'} space-y-3`;

                let html = `<p class="font-bold text-lg">${index + 1}. ${qText}</p>`;

                options.forEach((opt, optIndex) => {
                    const isUser = optIndex === q.userAnswer;
                    const isCorrectOption = optIndex === q.correct_answer_index;
                    let colorClass = 'text-gray-700';

                    if (isCorrectOption) {
                        colorClass = 'font-bold text-emerald-600';
                    } else if (isUser && !isCorrect) {
                        colorClass = 'font-bold text-red-600 line-through';
                    }

                    html += `<p class="ml-4 text-sm ${colorClass}">${String.fromCharCode(65 + optIndex)}. ${opt} ${isCorrectOption ? ' (Correct Answer)' : ''} ${isUser && !isCorrect ? ' (Your Answer)' : ''}</p>`;
                });

                html += `<div class="mt-3 p-3 bg-white rounded-lg border border-gray-200">
                         <p class="font-semibold text-violet-600">${L('review-explanation-text')}:</p>
                         <p class="text-sm text-gray-800">${explanationText}</p>
                     </div>`;

                card.innerHTML = html;
                reviewList.appendChild(card);
            });
        };


        // --- UI/VIEW MANAGEMENT ---

        const hideAllViews = () => {
            document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.replace('text-violet-500', 'text-gray-500'));
            document.getElementById('quiz-timer').classList.add('hidden');
        };

        const renderView = (viewName) => {
            if (!currentUser && viewName !== 'login') {
                viewName = 'login';
            }

            hideAllViews();
            currentView = viewName;

            const viewElement = document.getElementById(`${viewName}-view`);
            if (viewElement) viewElement.classList.remove('hidden');

            const activeNavBtn = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeNavBtn) activeNavBtn.classList.replace('text-gray-500', 'text-violet-500');

            switch (viewName) {
                case 'login':
                case 'profile-setup':
                    document.getElementById('bottom-nav').classList.add('hidden');
                    break;
                case 'dashboard':
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    renderDashboard();
                    break;
                case 'result':
                    document.getElementById('bottom-nav').classList.add('hidden');
                    renderResultView();
                    break;
                case 'profile':
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    updateProfileUI();
                    break;
                case 'leaderboard':
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    renderLeaderboard();
                    break;
                case 'history':
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    renderHistory();
                    break;
                case 'stage-selection':
                    document.getElementById('bottom-nav').classList.add('hidden');
                    document.getElementById('stage-selection-title').textContent = L('stage-selection-title');
                    document.getElementById('stage-selection-subtitle').textContent = L('stage-selection-subtitle');
                    break;
                case 'quiz':
                case 'review':
                    document.getElementById('bottom-nav').classList.add('hidden');
                    break;
            }
        };

        // --- DASHBOARD RENDERING & GAMIFIED STAGE SELECTION ---

        const renderDashboard = () => {
            checkWeeklyTestStatus();

            const mapContainer = document.getElementById('subject-stage-map');
            mapContainer.innerHTML = '';

            // FIX: Now the Candy Crush style is applied to the Subjects (Stages)
            SUBJECTS_DATA.reverse().forEach((subject, index) => {
                const node = document.createElement('div');

                const nodeButton = document.createElement('button');
                nodeButton.className = `subject-node ${subject.color} w-24 h-24 text-xl`;
                nodeButton.innerHTML = `
                <div class="text-center p-1">
                    <span class="text-3xl block">${subject.emoji}</span>
                    <span class="text-xs font-semibold">${subject.name}</span>
                </div>
            `;
                nodeButton.onclick = () => renderDifficultySelection(subject.name);

                const container = document.createElement('div');
                container.className = 'stage-node-container relative flex flex-col items-center';
                container.style.marginTop = `${index === 0 ? '0' : '40px'}`; // Space between nodes

                // Add the path line before the node, except for the first one
                if (index < SUBJECTS_DATA.length - 1) {
                    const path = document.createElement('div');
                    path.className = 'absolute top-[-40px] w-2 h-10 bg-gray-400 z-5';
                    container.appendChild(path);
                }

                container.appendChild(nodeButton);
                mapContainer.prepend(container); // Prepend to build map from bottom up (visually)
            });
            SUBJECTS_DATA.reverse(); // Reverse back for consistent array use
        };

        // This is now the Difficulty Selection Screen (Levels)
        const renderDifficultySelection = (subject) => {
            renderView('stage-selection');
            const list = document.getElementById('stage-list');
            list.innerHTML = '';
            document.getElementById('stage-selection-title').textContent = `${L('stage-selection-title')} - ${subject}`;
            document.getElementById('stage-selection-subtitle').textContent = L('stage-selection-subtitle');

            // Simple button list for levels/difficulty
            Object.keys(DIFFICULTIES).forEach(difficultyKey => {
                const diff = DIFFICULTIES[difficultyKey];
                const card = document.createElement('button');
                card.className = `w-full p-5 ${diff.color} text-white rounded-xl shadow-xl flex items-center justify-between transition duration-300 transform hover:scale-[1.03]`;
                card.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="text-3xl">${diff.emoji}</div>
                    <div>
                         <p class="text-xl font-bold">${diff.label[currentLanguage]}</p>
                         <p class="font-semibold text-sm opacity-90">${subject}</p>
                    </div>
                </div>
                <span class="font-semibold text-sm border border-white px-3 py-1 rounded-full">Score Multiplier: x${difficultyKey === 'hard' ? 3 : difficultyKey === 'medium' ? 2 : 1}</span>
            `;
                card.onclick = () => startQuiz(subject, difficultyKey, false);
                list.appendChild(card);
            });
        };

        // --- WEEKLY TEST LOGIC (PREMIUM FEATURE) ---

        const checkWeeklyTestStatus = () => {
            const today = new Date();
            const testCard = document.getElementById('weekly-test-card');
            const isSunday = today.getDay() === 0;

            const isTestEnabledByAdmin = isSunday;

            testCard.classList.add('hidden');
            isWeeklyTestAvailable = false;
            isTestPaid = userProfile.isTestPaid;

            const cardBtn = document.getElementById('test-card-btn');
            document.getElementById('test-card-title').textContent = L('test-card-title');

            if (isTestEnabledByAdmin) {
                isWeeklyTestAvailable = true;
                testCard.classList.remove('hidden');

                if (isTestPaid) {
                    testCard.classList.replace('bg-gray-400', 'bg-yellow-400');
                    testCard.classList.replace('border-gray-600', 'border-yellow-600');
                    document.getElementById('test-card-status').textContent = L('test-card-status-paid');
                    cardBtn.textContent = L('test-card-btn-start');
                    testCard.onclick = () => startQuiz('Weekly Test', 'hard', true);
                } else {
                    document.getElementById('test-card-status').textContent = L('test-card-status-pay');
                    cardBtn.textContent = L('test-card-btn-pay');
                    testCard.onclick = () => showPaymentModal();
                }
            } else {
                testCard.classList.remove('hidden');
                testCard.classList.replace('bg-yellow-400', 'bg-gray-400');
                testCard.classList.replace('border-yellow-600', 'border-gray-600');
                document.getElementById('test-card-status').textContent = L('test-card-status-inactive');
                cardBtn.textContent = 'CLOSED';
                testCard.onclick = null;
            }
        };

        const showPaymentModal = () => {
            showModal(
                L('modal-pay-title'),
                L('modal-pay-message'),
                true,
                () => {
                    const modal = document.getElementById('global-modal');
                    modal.classList.add('hidden');
                    showModal('Processing Payment...', 'Simulating transaction for ‚Çπ9.00. Please wait...', false);

                    setTimeout(async () => {
                        const userRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/profile`);
                        await update(userRef, { isTestPaid: true });

                        isTestPaid = true;
                        userProfile.isTestPaid = true;

                        showModal('Success!', 'Payment successful. All weekly tests are now unlocked permanently!', false);
                        checkWeeklyTestStatus();
                        updateProfileUI();
                    }, 2000);
                }
            );
        };

        // --- LEADERBOARD & HISTORY RENDERING ---

        const renderLeaderboard = async () => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = `<p class="text-center text-gray-500">${L('leaderboard-loading')}</p>`;

            const usersRef = ref(window.db, `artifacts/${window.appId}/users`);
            const snapshot = await get(usersRef);

            if (!snapshot.exists()) {
                list.innerHTML = `<p class="text-center text-gray-500">No scores yet.</p>`;
                return;
            }

            const userData = snapshot.val();
            let leaderboard = [];

            for (const uid in userData) {
                if (userData[uid].profile) {
                    leaderboard.push({
                        uid: uid,
                        ...userData[uid].profile
                    });
                }
            }

            leaderboard.sort((a, b) => (b.score || 0) - (a.score || 0));

            list.innerHTML = '';

            leaderboard.slice(0, 10).forEach((user, index) => {
                const rank = index + 1;
                const rankColor = rank === 1 ? 'text-yellow-500' : rank === 2 ? 'text-gray-400' : rank === 3 ? 'text-amber-700' : 'text-gray-600';
                const card = document.createElement('div');
                card.className = `p-3 bg-white rounded-xl shadow-lg flex items-center justify-between transition duration-150 transform hover:scale-[1.01] border-b-2 border-violet-200`;

                card.innerHTML = `
                <div class="flex items-center space-x-3">
                    <span class="text-xl font-extrabold w-8 text-center ${rankColor}">#${rank}</span>
                    <img src="${user.photoURL}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/40x40/8b5cf6/ffffff?text=P';" alt="Profile">
                    <div>
                        <p class="font-bold text-gray-800 truncate max-w-[150px]">${user.name}</p>
                        <p class="text-xs text-gray-500">${user.standard}th, ${user.medium}</p>
                    </div>
                </div>
                <span class="text-2xl font-bold text-violet-600">${user.score || 0}</span>
            `;
                list.appendChild(card);
            });
        };

        const renderHistory = async () => {
            const list = document.getElementById('history-list');
            list.innerHTML = `<p class="text-center text-gray-500">${L('history-loading')}</p>`;

            const historyRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/history`);
            const snapshot = await get(historyRef);

            if (!snapshot.exists()) {
                list.innerHTML = `<p class="text-center text-gray-500">No history available.</p>`;
                return;
            }

            const historyData = snapshot.val();
            let historyList = [];
            for (const key in historyData) {
                historyList.push(historyData[key]);
            }

            historyList.sort((a, b) => b.startTime - a.startTime);

            list.innerHTML = '';

            historyList.forEach(session => {
                const date = new Date(session.startTime).toLocaleDateString(currentLanguage === 'mr' ? 'mr-IN' : currentLanguage === 'hi' ? 'hi-IN' : 'en-US');
                const colorClass = session.correctCount > (session.questions.length / 2) ? 'bg-emerald-50' : 'bg-red-50';
                const statusEmoji = session.correctCount > (session.questions.length / 2) ? 'ü•≥' : '‚úçÔ∏è';

                const card = document.createElement('div');
                card.className = `p-4 ${colorClass} rounded-xl shadow-lg space-y-2 border-l-4 border-violet-500 cursor-pointer transition duration-200 hover:shadow-xl`;

                // FIX: Add click handler to review the history session, specifying source is 'history'
                card.onclick = () => openReviewScreen(session, 'history');

                card.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="text-lg font-bold text-gray-800">${session.subject} (${session.difficulty.toUpperCase()})</p>
                    <span class="text-sm text-gray-500">${date}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="font-semibold text-violet-600">Score: ${session.score} ${statusEmoji}</span>
                    <span class="font-semibold text-gray-700">Correct: ${session.correctCount}/${session.questions.length}</span>
                </div>
            `;
                list.appendChild(card);
            });
        };

        // --- GLOBAL MODAL SYSTEM (REPLACES alert/confirm) ---

        const showModal = (title, message, isConfirm = false, onConfirm = () => { }) => {
            const modal = document.getElementById('global-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            if (isConfirm) {
                confirmBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
            } else {
                confirmBtn.classList.add('hidden');
                cancelBtn.classList.remove('hidden');
                cancelBtn.textContent = 'Close';
            }

            confirmBtn.onclick = null;
            cancelBtn.onclick = null;

            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
                cancelBtn.textContent = 'Cancel';
            };
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                cancelBtn.textContent = 'Cancel';
            };

            modal.classList.remove('hidden');
        };

        // --- INITIALIZATION AND EVENT LISTENERS ---

        window.initApp = () => {
            const savedLang = localStorage.getItem('smartkid_lang');
            if (savedLang) {
                currentLanguage = savedLang;
            }
            document.getElementById('lang-select').value = currentLanguage;
            localizeElements();

            document.getElementById('google-sign-in-btn').addEventListener('click', signInWithGoogle);
            document.getElementById('profile-setup-form').addEventListener('submit', saveProfile);
            document.getElementById('quiz-next-btn').addEventListener('click', nextQuestion);
            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => renderView('dashboard'));

            // FIX: Review button now uses the dynamic logic function, setting source to 'result'
            document.getElementById('review-answers-btn').addEventListener('click', () => openReviewScreen(quizSession, 'result'));

            document.getElementById('sign-out-btn').addEventListener('click', signOutUser);

            // Language Chooser Listener is attached to the element now located in dashboard view
            document.getElementById('lang-select').addEventListener('change', (e) => {
                currentLanguage = e.target.value;
                localStorage.setItem('smartkid_lang', currentLanguage);
                localizeElements();
            });

            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.getAttribute('data-view');
                    renderView(view);
                });
            });

            if (!currentUser) {
                renderView('login');
            }
        };
    </script>
</body>

</html>
