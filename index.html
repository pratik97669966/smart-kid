<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Kid - рддреБрдордЪрд╛ рд╕реНрдорд╛рд░реНрдЯ рдЕрднреНрдпрд╛рд╕</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <!-- Firebase (modules are imported in the inline module script below) -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        :root {
            --primary: #8b5cf6;
            /* Violet-500 */
            --success: #10b981;
            /* Emerald-500 */
            --danger: #ef4444;
            /* Red-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Mobile Frame for focused view on large screens, responsive on small screens */
        .mobile-frame {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #ffffff;
            margin: auto;
        }

        .stage-card:hover,
        .exam-card:hover,
        .subject-card:hover,
        .paper-card:hover {
            transform: scale(1.03) translateY(-3px);
            box-shadow: 0 8px 15px rgba(139, 92, 246, 0.4);
        }

        /* Ensure result view is centered and visible */
        #quiz-result-view {
            min-height: 80vh;
            padding-top: 2rem;
            flex-direction: column;
            justify-content: center;
        }

        .correct-animation {
            animation: correctPulse 0.5s ease-in-out;
        }

        .wrong-animation {
            animation: wrongShake 0.5s ease-in-out;
        }

        @keyframes correctPulse {
            0% {
                transform: scale(1);
                background-color: white;
            }

            50% {
                transform: scale(1.05);
                background-color: var(--success);
            }

            100% {
                transform: scale(1);
                background-color: white;
            }
        }

        @keyframes wrongShake {

            0%,
            100% {
                transform: translateX(0);
                background-color: white;
            }

            20%,
            60% {
                transform: translateX(-5px);
                background-color: var(--danger);
            }

            40%,
            80% {
                transform: translateX(5px);
                background-color: var(--danger);
            }
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- Splash fade customization (IMPROVED) --- */
        #splash {
            transition: opacity 500ms ease, transform 400ms ease;
            will-change: opacity, transform;
        }

        /* Applied when we want to smoothly fade away the splash */
        .splash-hidden {
            opacity: 0;
            transform: scale(0.995);
            pointer-events: none;
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 1s ease-in-out forwards;
        }

        .animate-fade-in-up {
            animation: fade-in-up 1s ease-in-out forwards;
        }
    </style>
</head>

<body class="body-container p-0 min-h-screen bg-gray-100">

    <div class="mobile-frame">

        <!-- === SPLASH SCREEN (Improved) === -->
        <div id="splash"
            class="absolute inset-0 flex flex-col items-center justify-center text-white bg-gradient-to-br from-violet-600 via-indigo-500 to-blue-500 z-50 overflow-hidden">
            <div class="relative flex flex-col items-center">
                <!-- Glow behind logo -->
                <div class="absolute w-64 h-64 bg-white/10 rounded-full blur-3xl animate-pulse"></div>
                <h1 class="text-5xl sm:text-6xl font-extrabold drop-shadow-lg tracking-wide animate-bounce">Smart Kid
                </h1>
                <p class="mt-4 text-lg opacity-90 animate-fade-in">Loading your learning world...</p>

                <!-- Fancy Loader Bar -->
                <div class="w-64 h-2 mt-8 bg-white/30 rounded-full overflow-hidden">
                    <div id="loader-bar" class="h-full bg-white w-0 rounded-full transition-all duration-700 ease-out">
                    </div>
                </div>
            </div>
        </div>

        <!-- === LOGIN SCREEN (Improved) === -->
        <section id="login-view"
            class="hidden relative flex items-center justify-center min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-blue-50 px-4">
            <div
                class="flex flex-col md:flex-row bg-white rounded-3xl shadow-2xl overflow-hidden w-full max-w-4xl transform transition duration-500 scale-95 md:scale-100">

                <!-- Illustration (hidden on very small devices) -->
                <div class="hidden md:flex md:w-1/2  items-center justify-center relative">
                    <img src="https://placehold.co/400x400/f0e9ff/8b5cf6?text=Smart+Kid\n(Logo)"
                        onerror="this.onerror=null;this.src='https://placehold.co/400x400/f0e9ff/8b5cf6?text=Smart+Kid\n(Logo)';"
                        alt="Smart Learning Illustration" class="w-80 drop-shadow-2xl animate-fade-in-up" />
                </div>

                <!-- Form side -->
                <div class="flex-1 flex flex-col items-center justify-center p-8 sm:p-12 text-center space-y-6">
                    <div>
                        <h2 id="login-welcome" class="text-4xl font-extrabold text-violet-700 mb-2">Welcome to Smart
                            Kid!</h2>
                        <p id="login-tagline" class="text-gray-600">Learn, play, and grow with fun quizzes ЁЯОУ</p>
                    </div>

                    <!-- Google sign-in button -->
                    <button id="google-sign-in-btn"
                        class="w-full max-w-xs flex items-center justify-center gap-3 py-3 px-4 bg-white rounded-full shadow-lg hover:shadow-2xl transition duration-300 transform hover:scale-105 border border-gray-200">
                        <img class="w-6 h-6" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                            alt="Google logo" />
                        <span id="google-sign-in-text" class="text-gray-700 font-semibold">Sign in with Google</span>
                    </button>

                    <p class="text-xs text-gray-400">By signing in, you agree to our Terms & Privacy.</p>
                </div>
            </div>
        </section>


        <!-- Main App Container -->
        <div id="main-app-container" class="h-full flex flex-col hidden">

            <!-- Reusable Header Bar -->
            <header id="header-bar" class="p-4 bg-white shadow-md flex justify-between items-center z-10 sticky top-0">
                <div class="flex items-center space-x-3">
                    <button id="header-back-btn"
                        class="p-2 text-gray-500 hover:text-violet-500 rounded-full transition duration-150 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h1 id="header-title" class="text-xl font-bold text-gray-800"></h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="notification-btn"
                        class="p-2 text-gray-500 hover:text-violet-500 rounded-full transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                    </button>
                </div>
            </header>

            <!-- Main scrolling content area -->
            <main id="content-area" class="flex-grow overflow-y-auto p-4 pb-20">

                <!-- Profile Setup View -->
                <section id="profile-setup-view" class="p-6 bg-white rounded-xl shadow-2xl space-y-6 hidden">
                    <h2 id="setup-title" class="text-2xl font-extrabold text-violet-700 text-center">рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реЗрдЯрдЕрдк</h2>
                    <p id="setup-tagline" class="text-gray-600 text-center"></p>

                    <form id="profile-setup-form" class="space-y-4">
                        <div>
                            <label id="label-age" for="user-age" class="block text-sm font-medium text-gray-700">Age
                                (рд╡рдп)</label>
                            <input type="number" id="user-age" required min="8" max="18"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-violet-500 focus:ring-violet-500">
                        </div>
                        <div>
                            <label id="label-standard" for="user-standard"
                                class="block text-sm font-medium text-gray-700">Standard (рдЗрдпрддреНрддрд╛)</label>
                            <select id="user-standard" required
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-violet-500 focus:ring-violet-500">
                                <option value="" disabled selected>Select Standard</option>
                                <option value="5">5th Standard</option>
                                <option value="6">6th Standard</option>
                                <option value="7">7th Standard</option>
                                <option value="8">8th Standard</option>
                                <option value="9">9th Standard</option>
                                <option value="10">10th Standard</option>
                            </select>
                        </div>
                        <div>
                            <label id="label-medium" for="user-medium"
                                class="block text-sm font-medium text-gray-700">Medium (рдорд╛рдзреНрдпрдо)</label>
                            <select id="user-medium" required
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:border-violet-500 focus:ring-violet-500">
                                <option value="" disabled selected>Select Medium</option>
                                <option value="CBSE">CBSE (рд╕реАрдмреАрдПрд╕рдИ)</option>
                                <option value="State">State Board (рд░рд╛рдЬреНрдп рдордВрдбрд│)</option>
                            </select>
                        </div>
                        <button id="save-profile-btn" type="submit"
                            class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="save-profile-text">Save Profile</span>
                        </button>
                    </form>
                </section>

                <!-- Dashboard View -->
                <section id="dashboard-view" class="space-y-6 hidden">
                    <div
                        class="p-6 bg-violet-600 text-white rounded-2xl shadow-xl flex items-center justify-between mb-4">
                        <div>
                            <p id="welcome-greeting" class="text-xl font-medium"></p>
                            <h2 id="dashboard-user-name" class="text-3xl font-extrabold truncate max-w-[200px]"></h2>
                            <p class="text-sm opacity-90 mt-1">Score: <span id="dashboard-user-score">0</span> ЁЯПЖ</p>
                        </div>
                        <img id="dashboard-profile-img" src="https://placehold.co/64x64/8b5cf6/ffffff?text=P"
                            class="w-16 h-16 rounded-full border-4 border-white object-cover shadow-md"
                            alt="Profile Picture">
                    </div>

                    <!-- Language Toggle -->
                    <div id="language-toggle" class="relative text-center mb-6">
                        <label class="text-gray-700 font-semibold text-sm mr-2">Change Language:</label>
                        <select id="lang-select"
                            class="bg-gray-100 text-gray-700 text-sm p-2 rounded-lg border border-gray-300 focus:ring-violet-500 focus:border-violet-500 transition duration-150">
                            <option value="en">English</option>
                            <option value="mr">рдорд░рд╛рдареА</option>
                            <option value="hi">рд╣рд┐рдиреНрджреА</option>
                        </select>
                    </div>

                    <!-- Weekly Test Card -->
                    <div id="weekly-test-card"
                        class="p-4 bg-yellow-400 rounded-2xl shadow-lg border-4 border-yellow-600 transform transition duration-300 hover:scale-[1.02] cursor-pointer hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">тнР</span>
                                <div>
                                    <h3 id="test-card-title" class="text-xl font-bold text-yellow-800"></h3>
                                    <p id="test-card-status" class="text-sm text-yellow-700"></p>
                                </div>
                            </div>
                            <button id="test-card-btn"
                                class="bg-yellow-800 text-white text-sm font-bold py-1 px-4 rounded-full shadow-md"></button>
                        </div>
                    </div>

                    <!-- Exam Type Grid -->
                    <h3 id="exam-type-heading"
                        class="text-2xl font-extrabold text-gray-800 text-center pt-4 border-b-2 border-gray-200 pb-2">
                    </h3>
                    <div id="exam-type-grid" class="grid grid-cols-2 gap-4">
                        <!-- Exam type cards will be injected here -->
                    </div>
                </section>

                <!-- Subject Selection View (NEW) -->
                <section id="subject-selection-view" class="space-y-6 hidden">
                    <h2 id="subject-selection-title" class="text-3xl font-extrabold text-violet-700 text-center"></h2>
                    <div id="subject-list" class="flex flex-col space-y-4">
                        <!-- Subject cards will be injected here -->
                    </div>
                </section>

                <!-- Paper Selection View (NEW) -->
                <section id="paper-selection-view" class="space-y-6 hidden">
                    <h2 id="paper-selection-title" class="text-3xl font-extrabold text-violet-700 text-center"></h2>
                    <div id="paper-list" class="flex flex-col space-y-4">
                        <!-- Paper cards will be injected here -->
                    </div>
                </section>

                <!-- Stage (Difficulty) Selection View -->
                <section id="stage-selection-view" class="space-y-6 hidden">
                    <h2 id="stage-selection-title" class="text-3xl font-extrabold text-violet-700 text-center"></h2>
                    <p id="stage-selection-subtitle" class="text-center text-gray-600"></p>
                    <div id="stage-list" class="flex flex-col space-y-4">
                        <!-- Difficulty stages will be injected here -->
                    </div>
                </section>

                <!-- Quiz View -->
                <section id="quiz-view" class="space-y-4 hidden">
                    <div class="flex justify-between items-center pb-2 border-b border-gray-200">
                        <div id="quiz-status" class="text-lg font-semibold text-violet-600"></div>
                        <div id="quiz-timer"
                            class="text-xl font-bold text-red-500 border border-red-500 rounded-full px-3 py-1">00:00
                        </div>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg">
                        <p id="quiz-question-text" class="text-xl font-medium text-gray-800"></p>
                    </div>

                    <div id="quiz-options-container" class="space-y-3">
                        <!-- Options will be injected here -->
                    </div>

                    <div class="flex justify-end pt-4">
                        <button id="quiz-next-btn"
                            class="bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition duration-300 hidden"
                            disabled>
                            <span id="next-btn-text">Next Question</span>
                        </button>
                    </div>
                </section>

                <!-- Quiz Result View -->
                <section id="quiz-result-view"
                    class="h-full flex flex-col items-center justify-center text-center space-y-6 hidden">
                    <h2 id="result-title" class="text-4xl font-extrabold text-violet-700"></h2>
                    <p id="result-tagline" class="text-xl text-gray-600"></p>
                    <div id="result-score-ring"
                        class="mx-auto w-32 h-32 flex items-center justify-center rounded-full border-8 border-success bg-green-100 shadow-xl">
                        <span id="result-score" class="text-4xl font-bold text-success"></span>
                    </div>

                    <p id="result-details" class="text-lg font-medium text-gray-700"></p>

                    <div class="flex flex-col space-y-4 w-full max-w-sm">
                        <button id="review-answers-btn"
                            class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="review-btn-text">Review Answers</span>
                        </button>
                        <button id="back-to-dashboard-btn"
                            class="w-full bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            <span id="dashboard-btn-text">Go to Dashboard</span>
                        </button>
                    </div>
                </section>

                <!-- Review Answers View -->
                <section id="review-view" class="space-y-6 hidden">
                    <h2 id="review-title" class="text-3xl font-extrabold text-violet-700 border-b pb-2"></h2>
                    <div id="review-list" class="space-y-6">
                        <!-- Review cards will be injected here -->
                    </div>
                    <button id="close-review-btn"
                        class="w-full bg-violet-500 hover:bg-violet-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        <span id="close-review-text">Back to Results</span>
                    </button>
                </section>

                <!-- Profile View -->
                <section id="profile-view" class="space-y-6 hidden">
                    <h2 id="profile-page-title" class="text-3xl font-extrabold text-violet-700 text-center"></h2>
                    <div class="p-6 bg-white rounded-xl shadow-2xl space-y-4">
                        <img id="profile-page-img" src="https://placehold.co/100x100/8b5cf6/ffffff?text=P"
                            class="w-24 h-24 rounded-full border-4 border-violet-500 object-cover mx-auto shadow-lg"
                            alt="Profile Picture">
                        <p id="profile-user-name" class="text-2xl font-bold text-center"></p>
                        <p id="profile-user-id" class="text-xs text-gray-500 text-center truncate"></p>
                        <div id="profile-details" class="space-y-2">
                            <p id="profile-standard" class="text-gray-700"><span class="font-semibold">Standard:</span>
                                10th</p>
                            <p id="profile-medium" class="text-gray-700"><span class="font-semibold">Medium:</span> CBSE
                            </p>
                        </div>
                        <p id="test-paid-status" class="text-sm text-center font-medium"></p>
                    </div>
                    <button id="sign-out-btn"
                        class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                        <span id="sign-out-text">Sign Out</span>
                    </button>
                </section>

                <!-- Leaderboard View -->
                <section id="leaderboard-view" class="space-y-4 hidden">
                    <h2 id="leaderboard-title" class="text-3xl font-extrabold text-violet-700 border-b pb-2"></h2>
                    <div id="leaderboard-list" class="space-y-3">
                        <p id="leaderboard-loading" class="text-center text-gray-500"></p>
                    </div>
                </section>

                <!-- History View -->
                <section id="history-view" class="space-y-4 hidden">
                    <h2 id="history-title" class="text-3xl font-extrabold text-violet-700 border-b pb-2"></h2>
                    <div id="history-list" class="space-y-3">
                        <p id="history-loading" class="text-center text-gray-500"></p>
                    </div>
                </section>

                <!-- Global Modal -->
                <div id="global-modal"
                    class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50 p-4">
                    <div
                        class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-all scale-100 ease-out duration-300">
                        <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                        <p id="modal-message" class="text-gray-600 mb-6"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-full hover:bg-gray-100 transition duration-150">Cancel</button>
                            <button id="modal-confirm-btn"
                                class="px-4 py-2 bg-violet-500 text-white rounded-full hover:bg-violet-600 transition duration-150">Confirm</button>
                        </div>
                    </div>
                </div>

            </main>

            <!-- Bottom Navigation Bar -->
            <nav id="bottom-nav"
                class="fixed bottom-0 left-0 right-0 md:relative md:max-w-none md:rounded-b-2xl bg-white border-t border-gray-200 shadow-2xl flex justify-around items-center h-16 z-20">
                <!-- Use md:relative to stick to frame on desktop -->
                <button data-view="dashboard"
                    class="nav-item flex flex-col items-center p-2 text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span id="nav-dashboard-text" class="text-xs">Dashboard</span>
                </button>
                <button data-view="leaderboard"
                    class="nav-item flex flex-col items-center p-2 text-gray-500 hover:text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 10h4.765a2 2 0 01.358.31l1.598 1.597a2 2 0 010 2.828l-1.598 1.598a2 2 0 01-.358.31H14m-12 0h4.765a2 2 0 00.358.31l1.598 1.597a2 2 0 000 2.828l-1.598 1.598a2 2 0 00-.358.31H12M3 21h18" />
                    </svg>
                    <span id="nav-leaderboard-text" class="text-xs">Leaderboard</span>
                </button>
                <button data-view="history"
                    class="nav-item flex flex-col items-center p-2 text-gray-500 hover:text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="nav-history-text" class="text-xs">History</span>
                </button>
                <button data-view="profile"
                    class="nav-item flex flex-col items-center p-2 text-gray-500 hover:text-violet-500 font-medium transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="nav-profile-text" class="text-xs">Profile</span>
                </button>
            </nav>

        </div>
    </div>

    <!-- MAIN SCRIPT (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- EXPOSE FIREBASE FUNCTIONS GLOBALLY ---
        window.getAuth = getAuth;
        window.GoogleAuthProvider = GoogleAuthProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;

        // Realtime Database Functions
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.update = update;

        // --- USER-PROVIDED CONFIG (PLACEHOLDERS) ---
        // Configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyCaJX0lmumC-6J-iTHVB_PRe50Ww8oWp_g",
            authDomain: "smart-kid-balgram.firebaseapp.com",
            databaseURL: "https://smart-kid-balgram-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "smart-kid-balgram",
            storageBucket: "smart-kid-balgram.firebasestorage.app",
            messagingSenderId: "340279199689",
            appId: "1:340279199689:web:8d45a29b1ea87f3869ca18",
            measurementId: "G-W402LPG44J"
        };

        // Use environment variables if available, otherwise use defaults
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // Use the project ID as a fallback app ID
        window.appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-smart-kid-app';

        if (firebaseConfig) {
            window.app = initializeApp(firebaseConfig);
            window.auth = getAuth(window.app);
            window.db = getDatabase(window.app);
            window.googleProvider = new GoogleAuthProvider();

            // 1. Initial Authentication Logic
            onAuthStateChanged(window.auth, async (user) => {
                const splash = document.getElementById('splash');
                const mainApp = document.getElementById('main-app-container');

                if (user) {
                    window.userId = user.uid;
                    await checkOrCreateUserProfile(user);
                } else {
                    try {
                        // Try to sign in with custom token if provided
                        if (window.initialAuthToken) {
                            await signInWithCustomToken(window.auth, window.initialAuthToken);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Custom Token Error (Proceeding to Login Screen):", error);
                    }
                }

                // IMPROVED: Smoothly fade out splash then reveal app.
                if (splash) {
                    // Add class to trigger CSS opacity transition
                    splash.classList.add('splash-hidden');

                    // After CSS transition completes, hide the splash element and show main app
                    const FADE_MS = 500; // should match .splash-hidden transition duration
                    setTimeout(() => {
                        if (splash) splash.classList.add('hidden'); // remove from layout flow
                        if (mainApp) mainApp.classList.remove('hidden');
                        // Call the main app initialization function
                        if (typeof window.initApp === 'function') {
                            window.initApp();
                        }
                    }, FADE_MS + 40); // slight safety offset
                } else {
                    if (mainApp) mainApp.classList.remove('hidden');
                    if (typeof window.initApp === 'function') {
                        window.initApp();
                    }
                }
            });

        } else {
            console.error("Firebase configuration not found.");
        }
    </script>

    <!-- MAIN SCRIPT (Legacy) -->
    <script>
        // --- GLOBAL STATE AND CONFIGURATION ---
        const API_URL_TRIVIA = 'https://opentdb.com/api.php';

        let currentView = 'dashboard';
        let viewHistory = []; // Store history for back navigation
        let currentUser = null;
        let userProfile = null;
        let quizSession = null; // Holds current or last completed quiz session data
        let currentLanguage = 'mr';
        let isWeeklyTestAvailable = false;
        let isTestPaid = false;

        // NEW: Store current exam context
        let currentExamType = null;
        let currentSubject = null;

        // Subject Definitions: Added a 'standards' array to control visibility
        const SUBJECTS_DATA = [
            // Standard: 5th-7th focus on basics and GK
            { name: 'General Science', emoji: 'ЁЯФм', color: 'bg-green-500', categoryId: 17, standards: [5, 6, 7, 8, 9, 10] },
            { name: 'Basic Math', emoji: 'тЮХ', color: 'bg-red-500', categoryId: 19, standards: [5, 6, 7] },
            { name: 'Geography', emoji: 'ЁЯМН', color: 'bg-amber-500', categoryId: 22, standards: [5, 6, 7, 8] },
            { name: 'General Knowledge', emoji: 'ЁЯТб', color: 'bg-purple-500', categoryId: 9, standards: [5, 6, 7, 8, 9, 10] },

            // Standard: 8th-10th focus on history, advanced science/math
            { name: 'Advanced Math', emoji: 'ЁЯУР', color: 'bg-red-700', categoryId: 19, standards: [8, 9, 10] },
            { name: 'History (India)', emoji: 'ЁЯПЫя╕П', color: 'bg-blue-500', categoryId: 23, standards: [8, 9, 10] },
            { name: 'Computers', emoji: 'ЁЯТ╗', color: 'bg-cyan-500', categoryId: 18, standards: [8, 9, 10] },
            { name: 'Sports', emoji: 'тЪ╜', color: 'bg-pink-500', categoryId: 21, standards: [5, 6, 7, 8, 9, 10] },
        ];

        const TRIVIA_CATEGORIES = SUBJECTS_DATA.reduce((acc, s) => {
            acc[s.name] = s.categoryId;
            return acc;
        }, {});

        const DIFFICULTIES = {
            'easy': { label: { en: 'Easy', mr: 'рд╕реЛрдкреЗ', hi: 'рдЖрд╕рд╛рди' }, emoji: 'ЁЯС╢', color: 'bg-emerald-500' },
            'medium': { label: { en: 'Medium', mr: 'рдордзреНрдпрдо', hi: 'рдордзреНрдпрдо' }, emoji: 'ЁЯзС', color: 'bg-yellow-500' },
            'hard': { label: { en: 'Hard', mr: 'рдХрдареАрдг', hi: 'рдХрдард┐рди' }, emoji: 'ЁЯза', color: 'bg-red-500' }
        };

        // Localization Texts (Expanded)
        const TEXTS = {
            'login-welcome': { en: 'Welcome to Smart Kid!', mr: 'рд╕реНрдорд╛рд░реНрдЯ рдХрд┐рдбрдордзреНрдпреЗ рдЖрдкрд▓реЗ рд╕реНрд╡рд╛рдЧрдд рдЖрд╣реЗ!', hi: 'рд╕реНрдорд╛рд░реНрдЯ рдХрд┐рдб рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ!' },
            'login-tagline': { en: 'Learn like you play a game!', mr: 'рдЦреЗрд│рд╛рд╕рд╛рд░рдЦреЗ рд╢рд┐рдХрд╛!', hi: 'рдЦреЗрд▓ рдХреА рддрд░рд╣ рд╕реАрдЦреЗрдВ!' },
            'google-sign-in-text': { en: 'Sign in with Google', mr: 'рдЧреБрдЧрд▓рдиреЗ рд╕рд╛рдЗрди рдЗрди рдХрд░рд╛', hi: 'Google рд╕реЗ рд╕рд╛рдЗрди рдЗрди рдХрд░реЗрдВ' },
            'setup-title': { en: 'Profile Setup', mr: 'рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕реЗрдЯрдЕрдк', hi: 'рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕реЗрдЯ рдХрд░реЗрдВ' },
            'setup-tagline': { en: 'Tell us about yourself to tailor your content.', mr: 'рд╕рд╛рдордЧреНрд░реА рдЬреБрд│рд╡рдгреНрдпрд╛рд╕рд╛рдареА рдЖрдкрд▓реНрдпрд╛рдмрджреНрджрд▓ рд╕рд╛рдВрдЧрд╛.', hi: 'рд╕рд╛рдордЧреНрд░реА рдЕрдиреБрдХреВрд▓рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рдПрдВред' },
            'label-age': { en: 'Age (рд╡рдп)', mr: 'рд╡рдп (Age)', hi: 'рдЖрдпреБ (Age)' },
            'label-standard': { en: 'Standard (рдЗрдпрддреНрддрд╛)', mr: 'рдЗрдпрддреНрддрд╛ (Standard)', hi: 'рдХрдХреНрд╖рд╛ (Standard)' },
            'label-medium': { en: 'Medium (рдорд╛рдзреНрдпрдо)', mr: 'рдорд╛рдзреНрдпрдо (Medium)', hi: 'рдорд╛рдзреНрдпрдо (Medium)' },
            'save-profile-text': { en: 'Save Profile & Start', mr: 'рдкреНрд░реЛрдлрд╛рдЗрд▓ рдЬрддрди рдХрд░рд╛ рдЖрдгрд┐ рд╕реБрд░реВ рдХрд░рд╛', hi: 'рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рд╕рд╣реЗрдЬреЗрдВ рдФрд░ рд╢реБрд░реВ рдХрд░реЗрдВ' },
            'nav-dashboard-text': { en: 'Dashboard', mr: 'рдбреЕрд╢рдмреЛрд░реНрдб', hi: 'рдбреИрд╢рдмреЛрд░реНрдб' },
            'nav-leaderboard-text': { en: 'Leaderboard', mr: 'рд▓реАрдбрд░рдмреЛрд░реНрдб', hi: 'рд▓реАрдбрд░рдмреЛрд░реНрдб' },
            'nav-history-text': { en: 'History', mr: 'рдЗрддрд┐рд╣рд╛рд╕', hi: 'рдЗрддрд┐рд╣рд╛рд╕' },
            'nav-profile-text': { en: 'Profile', mr: 'рдкреНрд░реЛрдлрд╛рдЗрд▓', hi: 'рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓' },
            'welcome-greeting': { en: 'Hello, Scholar!', mr: 'рдирдорд╕реНрддреЗ, рд╡рд┐рджреНрд╡рд╛рдирд╛!', hi: 'рдирдорд╕реНрддреЗ, рд╡рд┐рджреНрд╡рд╛рди!' },

            // NEW/UPDATED Texts
            'exam-type-heading': { en: 'Select Exam Type', mr: 'рдкрд░реАрдХреНрд╖реЗрдЪрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рд╡рдбрд╛', hi: 'рдкрд░реАрдХреНрд╖рд╛ рдХрд╛ рдкреНрд░рдХрд╛рд░ рдЪреБрдиреЗрдВ' },
            'exam-regular': { en: 'Regular Quiz', mr: 'рдирд┐рдпрдорд┐рдд рдХреНрд╡рд┐рдЭ', hi: 'рдирд┐рдпрдорд┐рдд рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА' },
            'exam-scholarship': { en: 'Scholarship Exam', mr: 'рд╢рд┐рд╖реНрдпрд╡реГрддреНрддреА рдкрд░реАрдХреНрд╖рд╛', hi: 'рдЫрд╛рддреНрд░рд╡реГрддреНрддрд┐ рдкрд░реАрдХреНрд╖рд╛' },
            'exam-navodaya': { en: 'Navodaya Exam', mr: 'рдирд╡реЛрджрдп рдкрд░реАрдХреНрд╖рд╛', hi: 'рдирд╡реЛрджрдп рдкрд░реАрдХреНрд╖рд╛' },
            'premium-locked': { en: 'Premium ЁЯФТ', mr: 'рдкреНрд░реАрдорд┐рдпрдо ЁЯФТ', hi: 'рдкреНрд░реАрдорд┐рдпрдо ЁЯФТ' },
            'subject-selection-title': { en: 'Select Subject', mr: 'рд╡рд┐рд╖рдп рдирд┐рд╡рдбрд╛', hi: 'рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ' },
            'paper-selection-title': { en: 'Select Question Paper', mr: 'рдкреНрд░рд╢реНрдирдкрддреНрд░рд┐рдХрд╛ рдирд┐рд╡рдбрд╛', hi: 'рдкреНрд░рд╢реНрди рдкрддреНрд░ рдЪреБрдиреЗрдВ' },
            'no-subjects-found': { en: 'No subjects found for your standard in this category.', mr: 'рдпрд╛ рд╡рд░реНрдЧрд╛рдд рддреБрдордЪреНрдпрд╛ рдЗрдпрддреНрддреЗрд╕рд╛рдареА рдХреЛрдгрддреЗрд╣реА рд╡рд┐рд╖рдп рдЖрдврд│рд▓реЗ рдирд╛рд╣реАрдд.', hi: 'рдЗрд╕ рд╢реНрд░реЗрдгреА рдореЗрдВ рдЖрдкрдХреА рдХрдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╡рд┐рд╖рдп рдирд╣реАрдВ рдорд┐рд▓рд╛ред' },
            'no-papers-found': { en: 'No papers found for this subject.', mr: 'рдпрд╛ рд╡рд┐рд╖рдпрд╛рд╕рд╛рдареА рдХреЛрдгрддреЗрд╣реА рдкреЗрдкрд░ рдЖрдврд│рд▓реЗ рдирд╛рд╣реАрдд.', hi: 'рдЗрд╕ рд╡рд┐рд╖рдп рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдкреЗрдкрд░ рдирд╣реАрдВ рдорд┐рд▓рд╛ред' },
            'subjects-heading': { en: 'Choose Your Subject:', mr: 'рддреБрдордЪрд╛ рд╡рд┐рд╖рдп рдирд┐рд╡рдбрд╛:', hi: 'рдЕрдкрдирд╛ рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ:' }, // Kept for regular quiz

            'stage-selection-title': { en: 'Select Difficulty', mr: 'рдХрдареАрдг рдкрд╛рддрд│реА рдирд┐рд╡рдбрд╛', hi: 'рдХрдард┐рдирд╛рдИ рд╕реНрддрд░ рдЪреБрдиреЗрдВ' },
            'stage-selection-subtitle': { en: 'Higher difficulty means higher score points!', mr: 'рдЬрд╛рд╕реНрдд рдХрдард┐рдг рдореНрд╣рдгрдЬреЗ рдЬрд╛рд╕реНрдд рдЧреБрдг!', hi: 'рдЕрдзрд┐рдХ рдХрдард┐рдирд╛рдИ рдХрд╛ рдЕрд░реНрде рд╣реИ рдЕрдзрд┐рдХ рдЕрдВрдХ!' },
            'next-btn-text': { en: 'Next Question', mr: 'рдкреБрдврдЪрд╛ рдкреНрд░рд╢реНрди', hi: 'рдЕрдЧрд▓рд╛ рдкреНрд░рд╢реНрди' },
            'result-title-success': { en: 'Fantastic Job!', mr: 'рдЕрдкреНрд░рддрд┐рдо рдХрд╛рдо!', hi: 'рд╢рд╛рдирджрд╛рд░ рдХрд╛рдо!' },
            'result-title-fail': { en: 'Good Effort!', mr: 'рдЪрд╛рдВрдЧрд▓рд╛ рдкреНрд░рдпрддреНрди!', hi: 'рдЕрдЪреНрдЫрд╛ рдкреНрд░рдпрд╛рд╕!' },
            'result-tagline': { en: 'You earned {score} points!', mr: 'рддреБрдореНрд╣реА {score} рдЧреБрдг рдорд┐рд│рд╡рд▓реЗ!', hi: 'рдЖрдкрдиреЗ {score} рдЕрдВрдХ рдЕрд░реНрдЬрд┐рдд рдХрд┐рдП!' },
            'result-details': { en: 'Solved: {solved}/{total} | Correct: {correct}', mr: 'рд╕реЛрдбрд╡рд▓реЗ: {solved}/{total} | рдмрд░реЛрдмрд░: {correct}', hi: 'рд╣рд▓ рдХрд┐рдП рдЧрдП: {solved}/{total} | рд╕рд╣реА: {correct}' },
            'review-btn-text': { en: 'Review Answers', mr: 'рдЙрддреНрддрд░рд╛рдВрдЪреЗ рдкреБрдирд░рд╛рд╡рд▓реЛрдХрди рдХрд░рд╛', hi: 'рдЙрддреНрддрд░реЛрдВ рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХрд░реЗрдВ' },
            'dashboard-btn-text': { en: 'Go to Dashboard', mr: 'рдбреЕрд╢рдмреЛрд░реНрдбрд╡рд░ рдЬрд╛', hi: 'рдбреИрд╢рдмреЛрд░реНрдб рдкрд░ рдЬрд╛рдПрдВ' },
            'close-review-text': { en: 'Back to Results', mr: 'рдирд┐рдХрд╛рд▓рд╛рдВрд╡рд░ рдкрд░рдд', hi: 'рдкрд░рд┐рдгрд╛рдореЛрдВ рдкрд░ рд╡рд╛рдкрд╕' },
            'back-to-history-text': { en: 'Back to History', mr: 'рдЗрддрд┐рд╣рд╛рд╕рд╛рд╡рд░ рдкрд░рдд', hi: 'рдЗрддрд┐рд╣рд╛рд╕ рдкрд░ рд╡рд╛рдкрд╕' },
            'profile-page-title': { en: 'Your Profile', mr: 'рддреБрдордЪреА рдкреНрд░реЛрдлрд╛рдЗрд▓', hi: 'рдЖрдкрдХреА рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓' },
            'sign-out-text': { en: 'Sign Out', mr: 'рд╕рд╛рдЗрди рдЖрдЙрдЯ рдХрд░рд╛', hi: 'рд╕рд╛рдЗрди рдЖрдЙрдЯ рдХрд░реЗрдВ' },
            'test-card-title': { en: 'Weekly Scholar Test', mr: 'рд╕рд╛рдкреНрддрд╛рд╣рд┐рдХ рд╕реНрдХреЙрд▓рд░ рдЪрд╛рдЪрдгреА', hi: 'рд╕рд╛рдкреНрддрд╛рд╣рд┐рдХ рд╕реНрдХреЙрд▓рд░ рдЯреЗрд╕реНрдЯ' },
            'test-card-status-inactive': { en: 'Next test: Sunday!', mr: 'рдкреБрдврдЪреА рдЪрд╛рдЪрдгреА: рд░рд╡рд┐рд╡рд╛рд░!', hi: 'рдЕрдЧрд▓рд╛ рдЯреЗрд╕реНрдЯ: рд░рд╡рд┐рд╡рд╛рд░!' },
            'test-card-status-active': { en: 'Test is Live! Click to Start.', mr: 'рдЪрд╛рдЪрдгреА рд▓рд╛рдИрд╡реНрд╣ рдЖрд╣реЗ! рд╕реБрд░реВ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА рдХреНрд▓рд┐рдХ рдХрд░рд╛.', hi: 'рдЯреЗрд╕реНрдЯ рд▓рд╛рдЗрд╡ рд╣реИ! рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ.' },
            'test-card-status-paid': { en: 'Premium Access: UNLOCKED! тЬЕ', mr: 'рдкреНрд░реАрдорд┐рдпрдо рдкреНрд░рд╡реЗрд╢: рдЕрдирд▓реЙрдХ рдЭрд╛рд▓рд╛! тЬЕ', hi: 'рдкреНрд░реАрдорд┐рдпрдо рдПрдХреНрд╕реЗрд╕: рдЕрдирд▓реЙрдХ! тЬЕ' },
            'test-card-status-pay': { en: 'Unlock all Premium Tests!', mr: 'рд╕рд░реНрд╡ рдкреНрд░реАрдорд┐рдпрдо рдЪрд╛рдЪрдгреНрдпрд╛ рдЕрдирд▓реЙрдХ рдХрд░рд╛!', hi: 'рд╕рднреА рдкреНрд░реАрдорд┐рдпрдо рдЯреЗрд╕реНрдЯ рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ!' },
            'test-card-btn-start': { en: 'START TEST', mr: 'рдЪрд╛рдЪрдгреА рд╕реБрд░реВ рдХрд░рд╛', hi: 'рдЯреЗрд╕реНрдЯ рд╢реБрд░реВ рдХрд░реЗрдВ' },
            'test-card-btn-pay': { en: 'UNLOCK NOW', mr: 'рдЖрддрд╛ рдЕрдирд▓реЙрдХ рдХрд░рд╛', hi: 'рдЕрднреА рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ' },
            'leaderboard-title': { en: 'Global Top Scorers ЁЯПЖ', mr: 'рдЬрд╛рдЧрддрд┐рдХ рдЯреЙрдк рд╕реНрдХреЛрдЕрд░рд░реНрд╕ ЁЯПЖ', hi: 'рд╡реИрд╢реНрд╡рд┐рдХ рдЯреЙрдк рд╕реНрдХреЛрд░рд░ ЁЯПЖ' },
            'history-title': { en: 'My Quiz History ЁЯУЬ', mr: 'рдорд╛рдЭрд╛ рдХреНрд╡рд┐рдЭ рдЗрддрд┐рд╣рд╛рд╕ ЁЯУЬ', hi: 'рдореЗрд░рд╛ рдХреНрд╡рд┐рдЬрд╝ рдЗрддрд┐рд╣рд╛рд╕ ЁЯУЬ' },
            'history-loading': { en: 'Loading history...', mr: 'рдЗрддрд┐рд╣рд╛рд╕ рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗ...', hi: 'рдЗрддрд┐рд╣рд╛рд╕ рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...' },
            'leaderboard-loading': { en: 'Loading leaderboard...', mr: 'рд▓реАрдбрд░рдмреЛрд░реНрдб рд▓реЛрдб рд╣реЛрдд рдЖрд╣реЗ...', hi: 'рд▓реАрдбрд░рдмреЛрд░реНрдб рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...' },
            'question-loading': { en: 'Fetching Questions...', mr: 'рдкреНрд░рд╢реНрди рдЖрдгрд▓реЗ рдЬрд╛рдд рдЖрд╣реЗрдд...', hi: 'рдкреНрд░рд╢реНрди рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ...' },
            'question-generating-error': { en: 'Could not fetch questions. Try again.', mr: 'рдкреНрд░рд╢реНрди рдорд┐рд│реВ рд╢рдХрд▓реЗ рдирд╛рд╣реА. рдкреБрдиреНрд╣рд╛ рдкреНрд░рдпрддреНрди рдХрд░рд╛.', hi: 'рдкреНрд░рд╢реНрди рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛ рд╕рдХреЗред рдкреБрдирдГ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ.' },

            // UPDATED Modal Texts
            'modal-pay-title': { en: 'Unlock Premium Access', mr: 'рдкреНрд░реАрдорд┐рдпрдо рдкреНрд░рд╡реЗрд╢ рдЕрдирд▓реЙрдХ рдХрд░рд╛', hi: 'рдкреНрд░реАрдорд┐рдпрдо рдПрдХреНрд╕реЗрд╕ рдЕрдирд▓реЙрдХ рдХрд░реЗрдВ' },
            'modal-pay-message': { en: 'Confirm payment of тВ╣9.00 (One-time fee) to unlock <b>ALL</b> premium exams (Scholarship, Navodaya, Weekly Tests) permanently. (Razorpay Simulation)', mr: '<b>рд╕рд░реНрд╡</b> рдкреНрд░реАрдорд┐рдпрдо рдкрд░реАрдХреНрд╖рд╛ (рд╢рд┐рд╖реНрдпрд╡реГрддреНрддреА, рдирд╡реЛрджрдп, рд╕рд╛рдкреНрддрд╛рд╣рд┐рдХ рдЪрд╛рдЪрдгреНрдпрд╛) рдХрд╛рдпрдорд╕реНрд╡рд░реВрдкреА рдЕрдирд▓реЙрдХ рдХрд░рдгреНрдпрд╛рд╕рд╛рдареА тВ╣реп.режреж (рдПрдХ-рд╡реЗрд│ рд╢реБрд▓реНрдХ) рдкреЗрдореЗрдВрдЯрдЪреА рдкреБрд╖реНрдЯреА рдХрд░рд╛. (Razorpay рдЕрдиреБрдХрд░рдг)', hi: '<b>рд╕рднреА</b> рдкреНрд░реАрдорд┐рдпрдо рдкрд░реАрдХреНрд╖рд╛ (рдЫрд╛рддреНрд░рд╡реГрддреНрддрд┐, рдирд╡реЛрджрдп, рд╕рд╛рдкреНрддрд╛рд╣рд┐рдХ рдЯреЗрд╕реНрдЯ) рдХреЛ рд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдЕрдирд▓реЙрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП тВ╣реп.режреж (рдПрдХ рдмрд╛рд░ рдХрд╛ рд╢реБрд▓реНрдХ) рднреБрдЧрддрд╛рди рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░реЗрдВред (Razorpay рд╕рд┐рдореБрд▓реЗрд╢рди)' },

            'review-explanation-text': { en: 'Correct Answer Explanation', mr: 'рдпреЛрдЧреНрдп рдЙрддреНрддрд░рд╛рдЪреЗ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг', hi: 'рд╕рд╣реА рдЙрддреНрддрд░ рдХрд╛ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг' },
            'profile-test-paid': { en: 'Premium Access: PAID (Unlocked PermanTAINLY) ЁЯОЙ', mr: 'рдкреНрд░реАрдорд┐рдпрдо рдкреНрд░рд╡реЗрд╢: рд╕рд╢реБрд▓реНрдХ (рдХрд╛рдпрдорд╕реНрд╡рд░реВрдкреА рдЕрдирд▓реЙрдХ) ЁЯОЙ', hi: 'рдкреНрд░реАрдорд┐рдпрдо рдПрдХреНрд╕реЗрд╕: рднреБрдЧрддрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ (рд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдЕрдирд▓реЙрдХ) ЁЯОЙ' },
            'profile-test-unpaid': { en: 'Premium Access: UNPAID ЁЯФТ', mr: 'рдкреНрд░реАрдорд┐рдпрдо рдкреНрд░рд╡реЗрд╢: рд╕рд╢реБрд▓реНрдХ рдирд╛рд╣реА ЁЯФТ', hi: 'рдкреНрд░реАрдорд┐рдпрдо рдПрдХреНрд╕реЗрд╕: рднреБрдЧрддрд╛рди рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ ЁЯФТ' },
            'translation-note': { en: '(Question translated from English, content might be imprecise.)', mr: '(рдкреНрд░рд╢реНрди рдЗрдВрдЧреНрд░рдЬреАрддреВрди рдЕрдиреБрд╡рд╛рджрд┐рдд, рд╕рд╛рдордЧреНрд░реА рдЕрдЪреВрдХ рдирд╕реВ рд╢рдХрддреЗ.)', hi: '(рдкреНрд░рд╢реНрди рдЕрдВрдЧреНрд░реЗрдЬреА рд╕реЗ рдЕрдиреВрджрд┐рдд, рд╕рд╛рдордЧреНрд░реА рдЕрдкriрд╖реНрдХреГрдд рд╣реЛ рд╕рдХрддреА рд╣реИред)' }
        };

        // --- UTILITY FUNCTIONS ---

        // Simple text simulation for localization (Open Trivia is English-only)
        const simulateTranslation = (text) => {
            if (currentLanguage === 'en') return text;
            const baseText = text.length > 50 ? text.substring(0, 50) + '...' : text;
            if (currentLanguage === 'mr') {
                return `${baseText}`;
            } else if (currentLanguage === 'hi') {
                return `${baseText}`;
            }
            return text;
        };

        const decodeHtml = (html) => {
            const txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        }

        const L = (key) => TEXTS[key]?.[currentLanguage] || TEXTS[key]?.['en'] || key;

        const localizeElements = () => {
            const elements = [
                'login-welcome', 'login-tagline', 'google-sign-in-text', 'setup-title', 'setup-tagline',
                'label-age', 'label-standard', 'label-medium', 'save-profile-text',
                'nav-dashboard-text', 'nav-leaderboard-text', 'nav-history-text', 'nav-profile-text',
                'exam-type-heading', 'stage-selection-title', 'stage-selection-subtitle',
                'subject-selection-title', 'paper-selection-title',
                'next-btn-text', 'review-btn-text', 'dashboard-btn-text',
                'profile-page-title', 'sign-out-text', 'leaderboard-title', 'history-title',
                'leaderboard-loading', 'history-loading', 'question-loading', 'translation-note'
            ];
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = L(id);
            });

            if (userProfile) {
                document.getElementById('welcome-greeting').textContent = L('welcome-greeting');
                updateProfileUI();

                if (currentView === 'quiz-result' && quizSession) renderResultView();
                if (currentView === 'review' && quizSession) renderReviewView();
                if (currentView === 'dashboard') renderDashboard();
            }
        };
        // Tone.js Sound System
        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "sine" },
            envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.8 },
        }).toDestination();

        const playSound = (type) => {
            try {
                switch (type) {
                    case 'correct':
                        synth.triggerAttackRelease(['C5', 'E5', 'G5'], '8n');
                        break;
                    case 'wrong':
                        synth.triggerAttackRelease('C4', '4n');
                        break;
                    case 'level_up':
                        synth.triggerAttackRelease(['C5', 'G5', 'C6'], '2n', '+0.1');
                        break;
                }
            } catch (e) {
                console.warn("Audio context not started or Tone.js error:", e);
            }
        };

        // Fetch with exponential backoff for rate limiting
        const backoffFetch = async (url, options, maxRetries = 3) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { // Too Many Requests
                        throw new Error("Rate limit exceeded");
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000; // 1s, 2s, 4s + jitter
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

        // --- FIREBASE AND AUTHENTICATION LOGIC ---

        const signInWithGoogle = async () => {
            try {
                await Tone.start(); // Start audio context on user interaction
                await window.signInWithPopup(window.auth, window.googleProvider);
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                if (error.code !== 'auth/popup-closed-by-user') {
                    showModal('Error', error.message, false);
                }
            }
        };

        const signOutUser = async () => {
            try {
                await window.signOut(window.auth);
                location.reload(); // Easiest way to reset state
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        };

        const checkOrCreateUserProfile = async (user) => {
            const userRef = ref(window.db, `artifacts/${window.appId}/users/${user.uid}/profile`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                userProfile = snapshot.val();
                if (typeof userProfile.isTestPaid === 'undefined') {
                    userProfile.isTestPaid = false;
                    await update(userRef, { isTestPaid: false });
                }
                if (!userProfile.standard || !userProfile.medium) {
                    currentUser = user;
                    renderView('profile-setup');
                } else {
                    currentUser = user;
                    isTestPaid = userProfile.isTestPaid;
                    renderView('dashboard');
                }
            } else {
                currentUser = user;
                renderView('profile-setup');
            }
            updateProfileUI();
            checkWeeklyTestStatus();
        };

        const saveProfile = async (event) => {
            event.preventDefault();
            const age = document.getElementById('user-age').value;
            const standard = document.getElementById('user-standard').value;
            const medium = document.getElementById('user-medium').value;

            if (!age || !standard || !medium) return;

            const newProfile = {
                name: currentUser.displayName || 'Smart Kid User',
                email: currentUser.email || 'N/A',
                photoURL: currentUser.photoURL || 'https://placehold.co/64x64/8b5cf6/ffffff?text=P',
                age: parseInt(age),
                standard: standard,
                medium: medium,
                score: userProfile?.score || 0,
                isTestPaid: userProfile?.isTestPaid || false,
                lastUpdated: Date.now()
            };

            const profileRef = ref(window.db, `artifacts/${window.appId}/users/${currentUser.uid}/profile`);
            await set(profileRef, newProfile);
            userProfile = newProfile;
            isTestPaid = userProfile.isTestPaid;
            viewHistory = [];
            renderView('dashboard');
        };

        const updateProfileUI = () => {
            if (userProfile) {
                document.getElementById('dashboard-user-name').textContent = userProfile.name;
                document.getElementById('dashboard-profile-img').src = userProfile.photoURL;
                document.getElementById('dashboard-user-score').textContent = userProfile.score || 0;

                document.getElementById('profile-page-img').src = userProfile.photoURL;
                document.getElementById('profile-user-name').textContent = userProfile.name;
                document.getElementById('profile-user-id').textContent = `User ID: ${window.userId}`;
                document.getElementById('profile-standard').innerHTML = `<span class="font-semibold">${L('label-standard')}:</span> ${userProfile.standard}th`;
                document.getElementById('profile-medium').innerHTML = `<span class="font-semibold">${L('label-medium')}:</span> ${userProfile.medium}`;

                const paidStatusText = userProfile.isTestPaid ? L('profile-test-paid') : L('profile-test-unpaid');
                document.getElementById('test-paid-status').textContent = paidStatusText;
                document.getElementById('test-paid-status').className = `text-sm text-center font-medium ${userProfile.isTestPaid ? 'text-emerald-600' : 'text-red-600'}`;
            }
        };

        const saveQuizHistory = async (session) => {
            if (!window.userId) {
                console.error("saveQuizHistory: No user ID. Cannot save.");
                return;
            }
            try {
                const historyRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/history/${Date.now()}`);
                await set(historyRef, session);

                const newScore = (userProfile.score || 0) + session.score;
                const userScoreRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/profile`);
                await update(userScoreRef, { score: newScore });

                userProfile.score = newScore;
                updateProfileUI();
            } catch (error) {
                console.error("Firebase saveQuizHistory Error:", error);
                showModal('Save Error', 'Could not save your quiz result. Please check your internet connection.', false);
            }
        };

        // --- OPEN TRIVIA API & TRANSLATION LOGIC ---

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        const fetchQuizQuestions = async (subject, difficulty, count = 10) => {
            const categoryId = TRIVIA_CATEGORIES[subject] || 9;
            const diffParam = difficulty === 'hard' ? 'hard' : difficulty === 'medium' ? 'medium' : 'easy';
            const url = `${API_URL_TRIVIA}?amount=${count}&category=${categoryId}&difficulty=${diffParam}&type=multiple`;

            const questionContainer = document.getElementById('quiz-question-text');
            const optionsContainer = document.getElementById('quiz-options-container');

            questionContainer.innerHTML = `<div class="flex items-center justify-center space-x-2"><div class="loader" style="border-top-color: var(--primary);"></div><p class="text-gray-500">${L('question-loading')}</p></div>`;
            optionsContainer.innerHTML = '';

            try {
                const responseData = await backoffFetch(url);
                if (responseData.response_code !== 0) {
                    throw new Error(`Trivia API Error Code: ${responseData.response_code}`);
                }
                const questions = responseData.results.map(q => {
                    const incorrect = q.incorrect_answers.map(decodeHtml);
                    const correct = decodeHtml(q.correct_answer);
                    const allOptions = [...incorrect, correct];
                    shuffleArray(allOptions);
                    const correctIndex = allOptions.findIndex(opt => opt === correct);

                    let scoreValue = 0;
                    if (q.difficulty === 'hard') scoreValue = 30;
                    else if (q.difficulty === 'medium') scoreValue = 20;
                    else scoreValue = 10;

                    const q_en = decodeHtml(q.question);
                    const expl_en = `The correct answer is "${correct}" (Topic: ${q.category}).`;
                    const opts_en = allOptions;

                    return {
                        question_en: q_en,
                        question_mr: simulateTranslation(q_en),
                        question_hi: simulateTranslation(q_en),
                        options_en: opts_en,
                        options_mr: opts_en.map(simulateTranslation),
                        options_hi: opts_en.map(simulateTranslation),
                        correct_answer_index: correctIndex,
                        explanation_en: expl_en,
                        explanation_mr: simulateTranslation(expl_en),
                        explanation_hi: simulateTranslation(expl_en),
                        attempted: false,
                        userAnswer: -1,
                        scoreValue: scoreValue
                    };
                });
                return questions;
            } catch (error) {
                console.error("Trivia API Fetch Error:", error);
                questionContainer.textContent = L('question-generating-error');
                showModal('API Error', L('question-generating-error'), false);
                return null;
            }
        };


        // --- GAME LOGIC ---

        // (OTDB)
        const startQuiz = async (subject, difficulty, isTest = false) => {
            currentExamType = 'regular';
            currentSubject = subject;

            const questionData = await fetchQuizQuestions(subject, difficulty, isTest ? 15 : 10);
            if (!questionData || questionData.length === 0) {
                goBack();
                return;
            }
            quizSession = {
                subject: subject,
                difficulty: difficulty,
                questions: questionData,
                currentQIndex: 0,
                score: 0,
                correctCount: 0,
                isTest: isTest,
                startTime: Date.now(),
                duration: 0,
            };

            renderView('quiz');
            renderQuestion();
            startQuizTimer();
        };

        // (FIREBASE)
        const startFirebaseQuiz = (questions, examType, subjectName, paperTitle) => {
            currentExamType = examType;
            currentSubject = subjectName;

            // Ensure questions are in a valid array format
            const questionsArray = Array.isArray(questions) ? questions : Object.values(questions || {});

            if (!questionsArray || questionsArray.length === 0) {
                showModal("Error", "This paper seems to be empty.", false);
                goBack();
                return;
            }

            quizSession = {
                subject: `${subjectName} - ${paperTitle}`,
                difficulty: examType,
                questions: questionsArray.map(q => ({ ...q, attempted: false, userAnswer: -1 })),
                currentQIndex: 0,
                score: 0,
                correctCount: 0,
                isTest: true, // All Firebase quizzes are considered 'tests'
                startTime: Date.now(),
                duration: 0,
            };

            renderView('quiz');
            renderQuestion();
            startQuizTimer();
        };


        let quizTimerInterval = null;
        const startQuizTimer = () => {
            const timerElement = document.getElementById('quiz-timer');
            let totalSeconds = 0;
            clearInterval(quizTimerInterval);
            timerElement.textContent = '00:00';
            quizTimerInterval = setInterval(() => {
                totalSeconds++;
                const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const seconds = String(totalSeconds % 60).padStart(2, '0');
                timerElement.textContent = `${minutes}:${seconds}`;
            }, 1000);
        };

        const stopQuizTimer = () => {
            clearInterval(quizTimerInterval);
            const timerText = document.getElementById('quiz-timer').textContent;
            const parts = timerText.split(':').map(Number);
            if (quizSession) {
                quizSession.duration = parts[0] * 60 + parts[1];
            }
        };

        const renderQuestion = () => {
            if (!quizSession) return;
            const q = quizSession.questions[quizSession.currentQIndex];
            const currentQ = quizSession.currentQIndex + 1;
            const totalQ = quizSession.questions.length;

            document.getElementById('quiz-status').textContent = `Q ${currentQ}/${totalQ}`;
            document.getElementById('quiz-timer').classList.remove('hidden');

            const questionKey = `question_${currentLanguage}`;
            const optionsKey = `options_${currentLanguage}`;

            // Fallback logic: Use 'en' if the current language's data is missing
            const questionText = q[questionKey] || q.question_en;
            const options = q[optionsKey] || q.options_en;

            // Final fallback for safety
            if (!options || !Array.isArray(options)) {
                console.error("Invalid options data for question:", q);
                showModal("Quiz Error", "Failed to load question options. Skipping.", false);
                nextQuestion(); // Skip this broken question
                return;
            }

            document.getElementById('quiz-question-text').textContent = questionText;
            document.getElementById('quiz-next-btn').classList.add('hidden');
            document.getElementById('quiz-next-btn').disabled = true;

            const optionsContainer = document.getElementById('quiz-options-container');
            optionsContainer.innerHTML = '';
            optionsContainer.classList.remove('pointer-events-none');

            options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 bg-white rounded-xl shadow-lg border-2 border-gray-200 transition duration-150 hover:border-violet-500 hover:shadow-xl focus:outline-none option-btn`;
                button.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                button.dataset.index = index;
                button.onclick = () => selectOption(index);
                optionsContainer.appendChild(button);
            });
        };

        const selectOption = (selectedIndex) => {
            if (!quizSession || quizSession.questions[quizSession.currentQIndex].userAnswer !== -1) return;

            const q = quizSession.questions[quizSession.currentQIndex];
            const isCorrect = selectedIndex === q.correct_answer_index;

            q.attempted = true;
            q.userAnswer = selectedIndex;

            document.getElementById('quiz-options-container').classList.add('pointer-events-none');

            const optionButtons = document.querySelectorAll('#quiz-options-container .option-btn');
            optionButtons.forEach(btn => {
                const index = parseInt(btn.dataset.index);
                btn.classList.remove('hover:border-violet-500', 'hover:shadow-xl');
                if (index === q.correct_answer_index) {
                    btn.classList.add('bg-emerald-100', 'border-emerald-500', 'correct-animation');
                } else if (index === selectedIndex) {
                    btn.classList.add('bg-red-100', 'border-red-500', 'wrong-animation');
                } else {
                    btn.classList.add('opacity-50');
                }
            });

            if (isCorrect) {
                quizSession.correctCount++;
                quizSession.score += (q.scoreValue || 10); // Default to 10 if scoreValue is missing
                playSound('correct');
            } else {
                playSound('wrong');
            }

            document.getElementById('quiz-next-btn').classList.remove('hidden');
            document.getElementById('quiz-next-btn').disabled = false;
        };

        const nextQuestion = async () => {
            if (!quizSession) return;
            if (quizSession.currentQIndex < quizSession.questions.length - 1) {
                quizSession.currentQIndex++;
                renderQuestion();
            } else {
                stopQuizTimer();
                await endQuiz();
            }
        };

        const endQuiz = async () => {
            playSound('level_up');
            await saveQuizHistory(quizSession);
            renderView('quiz-result');
            renderResultView();
        };

        const renderResultView = () => {
            if (!quizSession || !quizSession.questions) {
                console.error("renderResultView called, but quizSession is empty.");
                const titleElement = document.getElementById('result-title');
                if (titleElement) titleElement.textContent = "Error";
                const taglineElement = document.getElementById('result-tagline');
                if (taglineElement) taglineElement.textContent = "Could not load quiz data.";
                return;
            }

            const titleElement = document.getElementById('result-title');
            const scoreRing = document.getElementById('result-score-ring');
            const scoreElement = document.getElementById('result-score');
            const taglineElement = document.getElementById('result-tagline');
            const detailsElement = document.getElementById('result-details');

            const score = quizSession.score;
            const totalQ = quizSession.questions.length;
            const correctQ = quizSession.correctCount;

            scoreRing.className = 'mx-auto w-32 h-32 flex items-center justify-center rounded-full border-8 shadow-xl';
            scoreElement.className = 'text-4xl font-bold';

            if (correctQ / totalQ > 0.7) {
                titleElement.textContent = L('result-title-success');
                scoreRing.classList.add('border-emerald-500', 'bg-green-100');
                scoreElement.classList.add('text-emerald-500');
            } else {
                titleElement.textContent = L('result-title-fail');
                scoreRing.classList.add('border-red-500', 'bg-red-100');
                scoreElement.classList.add('text-red-500');
            }

            scoreElement.textContent = score;
            taglineElement.textContent = L('result-tagline').replace('{score}', score);
            detailsElement.textContent = L('result-details')
                .replace('{solved}', totalQ)
                .replace('{total}', totalQ)
                .replace('{correct}', correctQ);
        };

        const openReviewScreen = (session, sourceView) => {
            quizSession = session;
            renderView('review', true); // Pass true to indicate it's a sub-view

            if (sourceView === 'history') {
                document.getElementById('close-review-btn').onclick = () => renderView('history');
                document.getElementById('close-review-text').textContent = L('back-to-history-text');
            } else {
                document.getElementById('close-review-btn').onclick = () => renderView('quiz-result');
                document.getElementById('close-review-text').textContent = L('close-review-text');
            }
        };

        const renderReviewView = () => {
            if (!quizSession || !quizSession.questions) {
                renderView('dashboard');
                return;
            }
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';
            document.getElementById('review-title').textContent = `${L('review-btn-text')} - ${quizSession.subject}`;

            const questionsArray = Array.isArray(quizSession.questions) ? quizSession.questions : Object.values(quizSession.questions || {});

            questionsArray.forEach((q, index) => {
                const isCorrect = q.userAnswer === q.correct_answer_index;
                const questionKey = `question_${currentLanguage}`;
                const explanationKey = `explanation_${currentLanguage}`;
                const optionsKey = `options_${currentLanguage}`;

                const qText = q[questionKey] || q.question_en;
                const explanationText = q[explanationKey] || q.explanation_en || "No explanation provided.";
                const options = q[optionsKey] || q.options_en;

                const card = document.createElement('div');
                card.className = `p-4 rounded-xl shadow-lg border-l-4 ${isCorrect ? 'border-emerald-500 bg-emerald-50' : 'border-red-500 bg-red-50'} space-y-3`;
                let html = `<p class="font-bold text-lg">${index + 1}. ${qText}</p>`;

                if (options && Array.isArray(options)) {
                    options.forEach((opt, optIndex) => {
                        const isUser = optIndex === q.userAnswer;
                        const isCorrectOption = optIndex === q.correct_answer_index;
                        let colorClass = 'text-gray-700';
                        if (isCorrectOption) {
                            colorClass = 'font-bold text-emerald-600';
                        } else if (isUser && !isCorrect) {
                            colorClass = 'font-bold text-red-600 line-through';
                        }
                        html += `<p class="ml-4 text-sm ${colorClass}">${String.fromCharCode(65 + optIndex)}. ${opt} ${isCorrectOption ? ' (Correct Answer)' : ''} ${isUser && !isCorrect ? ' (Your Answer)' : ''}</p>`;
                    });
                } else {
                    html += `<p class="ml-4 text-sm text-red-500">Error: Options not found.</p>`;
                }


                html += `<div class="mt-3 p-3 bg-white rounded-lg border border-gray-200">
                                 <p class="font-semibold text-violet-600">${L('review-explanation-text')}:</p>
                                 <p class="text-sm text-gray-800">${explanationText}</p>
                               </div>`;
                card.innerHTML = html;
                reviewList.appendChild(card);
            });
        };


        // --- UI/VIEW MANAGEMENT & BACK LOGIC ---

        const hideAllViews = () => {
            document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.replace('text-violet-500', 'text-gray-500'));
            document.getElementById('quiz-timer').classList.add('hidden');
            document.getElementById('header-title').textContent = '';
        };

        // isSubView parameter prevents pushing to history (e.g., review from result)
        const renderView = (viewName, isSubView = false) => {
            if (!currentUser && viewName !== 'login' && viewName !== 'profile-setup') {
                viewName = 'login';
            }

            // --- History Management ---
            // Only push to history if it's a new view, not a sub-view, and not a main tab
            if (viewName !== currentView && !isSubView && !['dashboard', 'leaderboard', 'history', 'profile', 'login', 'profile-setup'].includes(viewName)) {
                if (viewHistory.length === 0 || viewHistory[viewHistory.length - 1] !== currentView) {
                    viewHistory.push(currentView);
                }
            }
            // Reset history if navigating to a main tab
            if (['dashboard', 'leaderboard', 'history', 'profile'].includes(viewName)) {
                viewHistory = [];
            }
            // --- End History Management ---

            hideAllViews();
            currentView = viewName;

            const viewElement = document.getElementById(`${viewName}-view`);
            if (viewElement) viewElement.classList.remove('hidden');

            const activeNavBtn = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeNavBtn) activeNavBtn.classList.replace('text-gray-500', 'text-violet-500');

            const showNav = ['dashboard', 'leaderboard', 'history', 'profile'].includes(viewName);
            const bottomNav = document.getElementById('bottom-nav');
            bottomNav.classList.toggle('hidden', !showNav);

            const backBtn = document.getElementById('header-back-btn');
            const showBackBtn = viewHistory.length > 0 || ['quiz-result', 'review'].includes(viewName); // Show if history exists OR on result/review
            backBtn.classList.toggle('hidden', !showBackBtn);


            // --- View-Specific Logic ---
            switch (viewName) {
                case 'dashboard':
                    document.getElementById('header-title').textContent = 'Smart Kid';
                    renderDashboard();
                    break;
                case 'quiz-result':
                    document.getElementById('header-title').textContent = 'Quiz Result';
                    // renderResultView() is called by endQuiz()
                    break;
                case 'leaderboard':
                    document.getElementById('header-title').textContent = L('leaderboard-title');
                    renderLeaderboard();
                    break;
                case 'history':
                    document.getElementById('header-title').textContent = L('history-title');
                    renderHistory();
                    break;
                case 'profile':
                    document.getElementById('header-title').textContent = L('profile-page-title');
                    updateProfileUI();
                    break;
                case 'subject-selection':
                    document.getElementById('header-title').textContent = L('subject-selection-title');
                    break;
                case 'paper-selection':
                    document.getElementById('header-title').textContent = L('paper-selection-title');
                    break;
                case 'stage-selection':
                    document.getElementById('header-title').textContent = L('stage-selection-title');
                    break;
                case 'quiz':
                    document.getElementById('header-title').textContent = quizSession?.subject || 'Quiz';
                    break;
                case 'review':
                    document.getElementById('header-title').textContent = 'Review';
                    renderReviewView();
                    break;
            }
            console.log("Current View:", currentView, "History:", viewHistory);
        };

        const goBack = () => {
            // Special case: from quiz or result, always go to dashboard and clear session
            if (currentView === 'quiz' || currentView === 'quiz-result' || currentView === 'review') {
                quizSession = null;
                viewHistory = []; // Clear history stack
                renderView('dashboard');
                return;
            }

            let previousView = viewHistory.pop();
            if (previousView) {
                renderView(previousView);
            } else {
                if (currentUser) {
                    renderView('dashboard');
                } else {
                    renderView('login');
                }
            }
        };

        // --- SUBJECT FILTERING LOGIC ---
        const getStandardSubjects = (standard) => {
            if (!standard) return SUBJECTS_DATA;
            const std = parseInt(standard);
            return SUBJECTS_DATA.filter(subject => subject.standards.includes(std));
        };

        // --- DASHBOARD RENDERING (NEW) ---
        const renderDashboard = () => {
            if (!userProfile) return;
            checkWeeklyTestStatus();
            renderExamTypeGrid();
        };

        const renderExamTypeGrid = () => {
            const gridContainer = document.getElementById('exam-type-grid');
            gridContainer.innerHTML = '';

            const examTypes = [
                { id: 'regular', name: L('exam-regular'), emoji: 'ЁЯУЪ', color: 'bg-blue-500', isPremium: false },
                { id: 'scholarship', name: L('exam-scholarship'), emoji: 'ЁЯОУ', color: 'bg-green-500', isPremium: true },
                { id: 'navodaya', name: L('exam-navodaya'), emoji: 'ЁЯПл', color: 'bg-orange-500', isPremium: true },
            ];

            examTypes.forEach((exam) => {
                const card = document.createElement('button');
                const isLocked = exam.isPremium && !isTestPaid;

                card.className = `p-4 h-32 ${exam.color} ${isLocked ? 'opacity-70' : ''} text-white rounded-xl shadow-lg flex flex-col items-center justify-center space-y-2 font-bold transition duration-300 transform ${isLocked ? 'cursor-not-allowed' : 'hover:scale-[1.03] exam-card'}`;
                card.innerHTML = `
                    <span class="text-4xl">${exam.emoji}</span>
                    <span class="text-sm font-semibold text-center">${exam.name}</span>
                    ${isLocked ? `<span class="text-xs font-bold text-yellow-300">${L('premium-locked')}</span>` : ''}
                `;

                if (isLocked) {
                    card.onclick = () => showPaymentModal(() => renderSubjectSelection(exam.id)); // Pay then proceed
                } else if (exam.id === 'regular') {
                    card.onclick = () => renderSubjectSelection('regular');
                } else {
                    card.onclick = () => renderSubjectSelection(exam.id); // Scholarship or Navodaya (paid)
                }

                gridContainer.appendChild(card);
            });
        };

        // --- NEW: Subject Selection ---
        const renderSubjectSelection = async (examType) => {
            currentExamType = examType;
            renderView('subject-selection');
            const list = document.getElementById('subject-list');
            list.innerHTML = `<p class="text-center text-gray-500">${L('history-loading')}</p>`; // Re-use loading text
            document.getElementById('subject-selection-title').textContent = L('subject-selection-title');

            let subjects = [];

            if (examType === 'regular') {
                subjects = getStandardSubjects(userProfile.standard).map(s => ({
                    id: s.name,
                    name: s.name,
                    emoji: s.emoji,
                    color: s.color,
                }));
            } else {
                // Fetch from Firebase
                const fbSubjects = await fetchFirebaseSubjects(examType, userProfile.standard);
                subjects = fbSubjects.map(s => ({
                    id: s,
                    name: s, // "Math", "Science"
                    emoji: 'ЁЯУЭ', // Default emoji for FB subjects
                    color: 'bg-violet-500'
                }));
            }

            list.innerHTML = ''; // Clear loading
            if (subjects.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">${L('no-subjects-found')}</p>`;
                return;
            }

            subjects.forEach((subject) => {
                const card = document.createElement('button');
                card.className = `w-full p-5 ${subject.color} text-white rounded-xl shadow-xl flex items-center justify-between transition duration-300 transform hover:scale-[1.03] subject-card`;
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl">${subject.emoji}</div>
                        <p class="text-xl font-bold">${subject.name}</p>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                `;

                if (examType === 'regular') {
                    card.onclick = () => renderDifficultySelection(subject.id);
                } else {
                    card.onclick = () => renderPaperSelection(examType, subject.id);
                }
                list.appendChild(card);
            });
        };

        // --- NEW: Fetch Firebase Subjects ---
        const fetchFirebaseSubjects = async (examType, standard) => {
            try {
                const subjectsRef = ref(window.db, `artifacts/${window.appId}/exam_data/${examType}/${standard}`);
                const snapshot = await get(subjectsRef);
                if (snapshot.exists()) {
                    return Object.keys(snapshot.val()); // Returns ["Math", "Science", "English"]
                }
                return [];
            } catch (error) {
                console.error("Fetch Firebase Subjects Error:", error);
                showModal("Error", "Could not load subjects from database.", false);
                return [];
            }
        };

        // --- NEW: Paper Selection ---
        const renderPaperSelection = async (examType, subjectName) => {
            currentSubject = subjectName;
            renderView('paper-selection');
            const list = document.getElementById('paper-list');
            list.innerHTML = `<p class="text-center text-gray-500">${L('history-loading')}</p>`;
            document.getElementById('paper-selection-title').textContent = `${L('paper-selection-title')} - ${subjectName}`;

            const papers = await fetchFirebasePapers(examType, userProfile.standard, subjectName);
            list.innerHTML = ''; // Clear loading

            const paperKeys = Object.keys(papers);

            if (paperKeys.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500">${L('no-papers-found')}</p>`;
                return;
            }

            paperKeys.forEach(paperKey => {
                const paper = papers[paperKey];
                const card = document.createElement('button');
                card.className = `w-full p-5 bg-gray-700 text-white rounded-xl shadow-xl flex items-center justify-between transition duration-300 transform hover:scale-[1.03] paper-card`;
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl">ЁЯУД</div>
                        <p class="text-xl font-bold">${paper.title}</p>
                    </div>
                    <span class="font-semibold text-sm border border-white px-3 py-1 rounded-full">Start</span>
                `;
                card.onclick = () => startFirebaseQuiz(paper.questions, examType, subjectName, paper.title);
                list.appendChild(card);
            });
        };

        // --- NEW: Fetch Firebase Papers ---
        const fetchFirebasePapers = async (examType, standard, subjectName) => {
            try {
                const papersRef = ref(window.db, `artifacts/${window.appId}/exam_data/${examType}/${standard}/${subjectName}/papers`);
                const snapshot = await get(papersRef);
                if (!snapshot.exists()) {
                    return {};
                }

                const papersData = snapshot.val();
                // Convert questions objects to arrays if they aren't already
                Object.keys(papersData).forEach(paperKey => {
                    const paper = papersData[paperKey];
                    if (paper.questions && typeof paper.questions === 'object' && !Array.isArray(paper.questions)) {
                        paper.questions = Object.values(paper.questions);
                    }
                });
                return papersData;

            } catch (error) {
                console.error("Fetch Firebase Papers Error:", error);
                showModal("Error", "Could not load papers from database.", false);
                return {};
            }
        };


        // --- (Regular) Difficulty Selection ---
        const renderDifficultySelection = (subject) => {
            currentSubject = subject; // Keep track of subject
            renderView('stage-selection');
            const list = document.getElementById('stage-list');
            list.innerHTML = '';
            document.getElementById('stage-selection-title').textContent = `${L('stage-selection-title')} - ${subject}`;
            document.getElementById('stage-selection-subtitle').textContent = L('stage-selection-subtitle');

            Object.keys(DIFFICULTIES).forEach(difficultyKey => {
                const diff = DIFFICULTIES[difficultyKey];
                const card = document.createElement('button');
                card.className = `w-full p-5 ${diff.color} text-white rounded-xl shadow-xl flex items-center justify-between transition duration-300 transform hover:scale-[1.03] stage-card`;
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl">${diff.emoji}</div>
                        <div>
                                 <p class="text-xl font-bold">${diff.label[currentLanguage]}</p>
                                 <p class="font-semibold text-sm opacity-90">${subject}</p>
                        </div>
                    </div>
                    <span class="font-semibold text-sm border border-white px-3 py-1 rounded-full">Score: x${difficultyKey === 'hard' ? 3 : difficultyKey === 'medium' ? 2 : 1}</span>
                 `;
                card.onclick = () => startQuiz(subject, difficultyKey, false); // This is the OTDB quiz
                list.appendChild(card);
            });
        };

        // --- WEEKLY TEST LOGIC (Updated Payment) ---
        const checkWeeklyTestStatus = () => {
            const testCard = document.getElementById('weekly-test-card');
            if (!testCard) return;
            const isSunday = true; // Mocked for demo (new Date().getDay() === 0)
            const isTestEnabledByAdmin = isSunday;

            testCard.classList.add('hidden');
            isWeeklyTestAvailable = false;
            isTestPaid = userProfile?.isTestPaid || false;

            const cardBtn = document.getElementById('test-card-btn');
            document.getElementById('test-card-title').textContent = L('test-card-title');
            testCard.className = 'p-4 rounded-2xl shadow-lg border-4 transform transition duration-300 hover:scale-[1.02] cursor-pointer';

            if (isTestEnabledByAdmin) {
                isWeeklyTestAvailable = true;
                testCard.classList.remove('hidden');
                testCard.classList.add('bg-yellow-400', 'border-yellow-600');
                if (isTestPaid) {
                    document.getElementById('test-card-status').textContent = L('test-card-status-paid');
                    document.getElementById('test-card-status').className = 'text-sm text-yellow-700';
                    cardBtn.textContent = L('test-card-btn-start');
                    testCard.onclick = () => startQuiz('Weekly Test (Premium)', 'hard', true); // Uses OTDB
                } else {
                    document.getElementById('test-card-status').textContent = L('test-card-status-pay');
                    document.getElementById('test-card-status').className = 'text-sm text-red-700 font-semibold';
                    cardBtn.textContent = L('test-card-btn-pay');
                    testCard.onclick = () => showPaymentModal(() => {
                        // On successful payment, auto-start the weekly test
                        startQuiz('Weekly Test (Premium)', 'hard', true);
                    });
                }
            } else {
                testCard.classList.remove('hidden');
                testCard.classList.add('bg-gray-400', 'border-gray-600', 'cursor-not-allowed');
                document.getElementById('test-card-status').textContent = L('test-card-status-inactive');
                document.getElementById('test-card-status').className = 'text-sm text-gray-700';
                cardBtn.textContent = 'CLOSED';
                testCard.onclick = null;
            }
        };

        const showPaymentModal = (onConfirmCallback = () => { }) => {
            showModal(
                L('modal-pay-title'),
                L('modal-pay-message'),
                true,
                () => { // onConfirm
                    const modal = document.getElementById('global-modal');
                    modal.classList.add('hidden');
                    showModal('Processing Payment...', 'Simulating transaction for тВ╣9.00 via Razorpay... Please wait.', false);
                    setTimeout(async () => {
                        const userRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/profile`);
                        await update(userRef, { isTestPaid: true });
                        isTestPaid = true;
                        userProfile.isTestPaid = true;
                        document.getElementById('global-modal').classList.add('hidden');
                        showModal('Success! ЁЯОЙ', 'Payment successful. All premium content is now unlocked permanently!', false);

                        // Update UI
                        checkWeeklyTestStatus();
                        renderDashboard(); // Re-render dashboard to unlock cards
                        updateProfileUI();

                        // Execute the callback (e.g., proceed to subject selection)
                        onConfirmCallback();
                    }, 2000);
                }
            );
        };

        // --- LEADERBOARD & HISTORY RENDERING ---
        const renderLeaderboard = async () => {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = `<p class="text-center text-gray-500">${L('leaderboard-loading')}</p>`;
            const usersRef = ref(window.db, `artifacts/${window.appId}/users`);
            const snapshot = await get(usersRef);
            if (!snapshot.exists()) {
                list.innerHTML = `<p class="text-center text-gray-500">No scores yet.</p>`;
                return;
            }
            const userData = snapshot.val();
            let leaderboard = [];
            for (const uid in userData) {
                if (userData[uid].profile) {
                    leaderboard.push({
                        uid: uid,
                        ...userData[uid].profile
                    });
                }
            }
            leaderboard.sort((a, b) => (b.score || 0) - (a.score || 0));
            list.innerHTML = '';
            leaderboard.slice(0, 10).forEach((user, index) => {
                const rank = index + 1;
                const rankColor = rank === 1 ? 'text-yellow-500' : rank === 2 ? 'text-gray-400' : rank === 3 ? 'text-amber-700' : 'text-gray-600';
                const card = document.createElement('div');
                card.className = `p-3 bg-white rounded-xl shadow-lg flex items-center justify-between transition duration-150 transform hover:scale-[1.01] border-b-2 ${user.isTestPaid ? 'border-yellow-400' : 'border-violet-200'}`;
                card.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-xl font-extrabold w-8 text-center ${rankColor}">#${rank}</span>
                        <img src="${user.photoURL}" class="w-10 h-10 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/40x40/8b5cf6/ffffff?text=P';" alt="Profile">
                        <div>
                            <p class="font-bold text-gray-800 truncate max-w-[150px]">${user.name} ${user.isTestPaid ? 'тнР' : ''}</p>
                            <p class="text-xs text-gray-500">${user.standard}th, ${user.medium}</p>
                        </div>
                    </div>
                    <span class="text-2xl font-bold text-violet-600">${user.score || 0}</span>
                 `;
                list.appendChild(card);
            });
        };

        const renderHistory = async () => {
            const list = document.getElementById('history-list');
            list.innerHTML = `<p class="text-center text-gray-500">${L('history-loading')}</p>`;
            const historyRef = ref(window.db, `artifacts/${window.appId}/users/${window.userId}/history`);
            const snapshot = await get(historyRef);
            if (!snapshot.exists()) {
                list.innerHTML = `<p class="text-center text-gray-500">No history available.</p>`;
                return;
            }
            const historyData = snapshot.val();
            let historyList = [];
            for (const key in historyData) {
                historyList.push(historyData[key]);
            }
            historyList.sort((a, b) => b.startTime - a.startTime);
            list.innerHTML = '';
            historyList.forEach(session => {
                const date = new Date(session.startTime).toLocaleDateString(currentLanguage === 'mr' ? 'mr-IN' : currentLanguage === 'hi' ? 'hi-IN' : 'en-US');

                // Ensure questions is an array for length check
                const questionsArray = Array.isArray(session.questions) ? session.questions : Object.values(session.questions || {});
                const totalQuestions = questionsArray.length;
                if (totalQuestions === 0) return; // Don't render broken history items

                const colorClass = session.correctCount > (totalQuestions / 2) ? 'bg-emerald-50' : 'bg-red-50';
                const statusEmoji = session.correctCount > (totalQuestions / 2) ? 'ЁЯе│' : 'тЬНя╕П';
                const card = document.createElement('div');
                card.className = `p-4 ${colorClass} rounded-xl shadow-lg space-y-2 border-l-4 border-violet-500 cursor-pointer transition duration-200 hover:shadow-xl`;
                card.onclick = () => openReviewScreen(session, 'history');
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="text-lg font-bold text-gray-800">${session.subject} (${session.difficulty.toUpperCase()})</p>
                        <span class="text-sm text-gray-500">${date}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="font-semibold text-violet-600">Score: ${session.score} ${statusEmoji}</span>
                        <span class="font-semibold text-gray-700">Correct: ${session.correctCount}/${totalQuestions}</span>
                    </div>
                 `;
                list.appendChild(card);
            });
        };

        // --- GLOBAL MODAL SYSTEM ---
        const showModal = (title, message, isConfirm = false, onConfirm = () => { }) => {
            const modal = document.getElementById('global-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            if (isConfirm) {
                confirmBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                cancelBtn.textContent = 'Cancel';
                confirmBtn.textContent = 'Confirm';
                confirmBtn.classList.replace('bg-violet-500', 'bg-emerald-500');
                confirmBtn.classList.replace('hover:bg-violet-600', 'hover:bg-emerald-600');
            } else {
                confirmBtn.classList.add('hidden');
                cancelBtn.classList.remove('hidden');
                cancelBtn.textContent = 'Close';
            }
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
                confirmBtn.classList.replace('bg-emerald-500', 'bg-violet-500');
                confirmBtn.classList.replace('hover:bg-emerald-600', 'hover:bg-violet-600');
            };
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                confirmBtn.classList.replace('bg-emerald-500', 'bg-violet-500');
                confirmBtn.classList.replace('hover:bg-emerald-600', 'hover:bg-violet-600');
            };
            modal.classList.remove('hidden');
        };

        // --- INITIALIZATION AND EVENT LISTENERS ---
        window.initApp = () => {
            const savedLang = localStorage.getItem('smartkid_lang');
            if (savedLang) {
                currentLanguage = savedLang;
            }
            document.getElementById('lang-select').value = currentLanguage;
            localizeElements();

            // Hook the improved Google sign-in button
            const googleBtn = document.getElementById('google-sign-in-btn');
            if (googleBtn) {
                googleBtn.addEventListener('click', async () => {
                    if (typeof signInWithGoogle === 'function') {
                        signInWithGoogle();
                    }
                });
            }

            document.getElementById('profile-setup-form').addEventListener('submit', saveProfile);
            document.getElementById('quiz-next-btn').addEventListener('click', nextQuestion);
            document.getElementById('header-back-btn').addEventListener('click', goBack);

            document.getElementById('back-to-dashboard-btn').addEventListener('click', () => {
                quizSession = null;
                renderView('dashboard');
            });
            document.getElementById('review-answers-btn').addEventListener('click', () => {
                if (quizSession) {
                    openReviewScreen(quizSession, 'quiz-result');
                } else {
                    renderView('dashboard');
                }
            });
            document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
            document.getElementById('lang-select').addEventListener('change', (e) => {
                currentLanguage = e.target.value;
                localStorage.setItem('smartkid_lang', currentLanguage);
                localizeElements();
            });
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.getAttribute('data-view');
                    if (view === 'dashboard') {
                        quizSession = null;
                    }
                    viewHistory = [];
                    renderView(view);
                });
            });

            if (!currentUser) {
                renderView('login');
            }
        };
    </script>
</body>

</html>
